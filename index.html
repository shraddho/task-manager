<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×× ×”×œ ××©×™××•×ª</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; direction:rtl; }
        .header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:15px 20px; text-align:center; position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .header h1 { font-size:20px; }
        .header p { font-size:12px; opacity:0.85; margin-top:3px; }
        .sync-bar { background:#fff9e6; border-bottom:2px solid #ffc107; padding:10px 15px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; font-size:13px; }
        .sync-status { display:flex; align-items:center; gap:6px; color:#666; font-size:13px; }
        .sync-dot { width:10px; height:10px; border-radius:50%; background:#ccc; flex-shrink:0; }
        .sync-dot.synced { background:#4caf50; }
        .sync-dot.pending { background:#ffc107; animation:pulse 1s infinite; }
        .sync-dot.error { background:#f44336; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .sync-btns { display:flex; gap:8px; flex-wrap:wrap; }
        .btn-sync { color:white; font-size:13px; padding:8px 14px; min-height:36px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .bottom-nav { display:none; position:fixed; bottom:0; left:0; right:0; background:white; border-top:2px solid #eee; z-index:200; }
        .bottom-nav-inner { display:grid; grid-template-columns:repeat(4,1fr); }
        .nav-btn { display:flex; flex-direction:column; align-items:center; padding:10px 5px; background:none; border:none; cursor:pointer; font-size:10px; color:#888; }
        .nav-btn .icon { font-size:22px; margin-bottom:3px; }
        .nav-btn.active { color:#667eea; font-weight:700; }
        .desktop-layout { max-width:1400px; margin:0 auto; background:white; }
        .desktop-content { padding:20px; }
        .mobile-layout { display:none; }
        .mobile-page { display:none; padding:15px; padding-bottom:80px; background:white; min-height:calc(100vh - 55px); }
        .mobile-page.active { display:block; }
        .stats { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px; }
        .stat-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:15px 10px; border-radius:12px; text-align:center; }
        .stat-number { font-size:26px; font-weight:700; }
        .stat-label { font-size:11px; opacity:0.9; margin-top:2px; }
        .calendar-wrapper { background:#f8f9fa; border-radius:12px; padding:15px; margin-bottom:20px; }
        .cal-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .cal-nav-btn { padding:8px 14px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; min-width:44px; min-height:44px; }
        .cal-title { font-weight:600; font-size:14px; text-align:center; flex:1; }
        .cal-table { width:100%; border-collapse:collapse; background:white; border:2px solid #ddd; }
        .cal-table th { background:#667eea; color:white; padding:12px 5px; text-align:center; font-size:12px; border:1px solid #5568d3; }
        .cal-table th.time-col { width:65px; background:#5568d3; }
        .cal-table td { border:1px solid #e0e0e0; padding:3px; vertical-align:top; height:55px; }
        .cal-table td.time-cell { background:#f5f5f5; text-align:center; font-weight:600; font-size:11px; color:#666; }
        .cal-table td.day-cell { background:white; }
        .cal-table td.has-event { background:#fffde7; }
        .mobile-cal { display:none; }
        .mobile-day-nav { display:flex; justify-content:space-between; align-items:center; background:white; border-radius:10px; padding:10px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
        .mobile-day-nav-btn { padding:8px 16px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:18px; min-width:44px; min-height:44px; }
        .mobile-day-label { font-weight:700; font-size:16px; text-align:center; color:#333; }
        .mobile-day-body { background:white; border-radius:10px; padding:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); min-height:200px; }
        .hour-row { display:flex; min-height:52px; border-bottom:1px solid #f0f0f0; padding:4px 0; align-items:flex-start; }
        .hour-label { width:52px; font-size:11px; font-weight:600; color:#999; padding-top:4px; flex-shrink:0; }
        .hour-events { flex:1; }
        .cal-event { padding:3px 7px; margin:2px 0; border-radius:4px; font-size:11px; border-right:3px solid; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .cal-event.free-time { background:#f1f8e9; border-color:#8bc34a; color:#33691e; }
        .cal-event.planned { background:#fff3e0; border-color:#ff9800; color:#e65100; font-weight:600; }
        .cal-event.deadline { background:#ffebee; border-color:#f44336; color:#b71c1c; font-weight:700; }
        .legend { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; font-size:12px; }
        .legend-item { display:flex; align-items:center; gap:5px; }
        .legend-dot { width:14px; height:14px; border-radius:3px; }
        .section { margin-bottom:25px; }
        .section-title { color:#667eea; font-size:18px; font-weight:700; border-bottom:2px solid #667eea; padding-bottom:8px; margin-bottom:14px; }
        .form-group { margin-bottom:13px; }
        .form-label { display:block; margin-bottom:6px; font-weight:600; color:#333; font-size:14px; }
        .form-input,.form-select,.form-textarea { width:100%; padding:13px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px; font-family:inherit; direction:rtl; text-align:right; background:white; -webkit-appearance:none; appearance:none; }
        .form-input:focus,.form-select:focus,.form-textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.15); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .check-group { display:flex; gap:15px; flex-wrap:wrap; align-items:center; }
        .check-group label { display:flex; align-items:center; gap:7px; font-size:15px; cursor:pointer; }
        .check-group input[type=checkbox],.check-group input[type=radio] { width:20px; height:20px; cursor:pointer; accent-color:#667eea; }
        .radio-group { display:flex; gap:15px; flex-wrap:wrap; align-items:center; margin-top:8px; }
        .radio-group label { display:flex; align-items:center; gap:7px; font-size:15px; cursor:pointer; }
        .btn { padding:13px 20px; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s; min-height:48px; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
        .btn-secondary { background:#e8e8e8; color:#333; }
        .btn-danger { background:#f44336; color:white; padding:8px 13px; font-size:13px; min-height:36px; border:none; border-radius:8px; cursor:pointer; }
        .btn-success { background:#4caf50; color:white; padding:9px 14px; font-size:13px; min-height:36px; border:none; border-radius:8px; cursor:pointer; }
        .btn-whatsapp { background:#25D366; color:white; padding:9px 14px; font-size:13px; min-height:44px; border:none; border-radius:10px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:5px; }
        .btn-gcal { background:#4285f4; color:white; padding:9px 14px; font-size:13px; min-height:36px; text-decoration:none; border-radius:10px; display:inline-flex; align-items:center; gap:5px; font-weight:600; }
        .btn-export { background:#4285f4; color:white; font-size:13px; padding:9px 14px; min-height:36px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
        .task-card { background:#f9f9f9; border:2px solid #e0e0e0; border-radius:12px; padding:15px; margin-bottom:12px; border-right:5px solid #667eea; }
        .task-card.planned { border-right-color:#4caf50; background:#f1f8f4; }
        .task-card.done { opacity:0.55; }
        .task-card.partial { border-right-color:#ff9800; background:#fff8f0; }
        .task-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:8px; }
        .task-name { font-size:16px; font-weight:700; color:#222; }
        .task-name.done-text { text-decoration:line-through; color:#888; }
        .badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; margin:3px 3px 0 0; }
        .badge-subject { background:#667eea; color:white; }
        .badge-planned { background:#4caf50; color:white; }
        .badge-urgent { background:#f44336; color:white; }
        .badge-partial { background:#ff9800; color:white; }
        .task-meta { font-size:13px; color:#666; line-height:1.8; margin:6px 0; }
        .task-help { background:#fff3e0; border-right:4px solid #ff9800; padding:8px 10px; border-radius:6px; font-size:12px; color:#e65100; margin:8px 0; }
        .task-planned-info { background:#e8f5e9; border-right:4px solid #4caf50; padding:8px 10px; border-radius:6px; font-size:12px; color:#2e7d32; margin:8px 0; }
        .task-partial-info { background:#fff3e0; border-right:4px solid #ff9800; padding:8px 10px; border-radius:6px; font-size:12px; color:#e65100; margin:8px 0; }
        .task-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
        .task-done-check { display:flex; align-items:center; gap:7px; cursor:pointer; font-size:14px; }
        .task-done-check input { width:20px; height:20px; accent-color:#667eea; }
        .slot-item { background:white; border:1px solid #e0e0e0; border-right:4px solid #667eea; border-radius:8px; padding:10px 12px; margin-top:8px; display:flex; justify-content:space-between; align-items:center; }
        .slot-item.recurring { border-right-color:#9c27b0; }
        .slot-info { font-size:13px; line-height:1.7; }
        .badge-recurring { background:#9c27b0; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px; }
        .schedule-card { background:white; border-right:4px solid #667eea; border-radius:8px; padding:12px; margin-bottom:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
        .schedule-card-title { font-weight:700; color:#222; margin-bottom:4px; font-size:14px; }
        .schedule-card-meta { font-size:13px; color:#666; line-height:1.7; }
        .modal { display:none; position:fixed; z-index:500; inset:0; background:rgba(0,0,0,0.55); overflow-y:auto; }
        .modal-box { background:white; margin:5% auto 20px; padding:20px; border-radius:14px; width:92%; max-width:520px; }
        .modal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
        .modal-head h3 { color:#667eea; font-size:19px; }
        .modal-close { font-size:26px; cursor:pointer; color:#aaa; line-height:1; }
        .slot-option { background:#f9f9f9; border:2px solid #e0e0e0; border-radius:8px; padding:13px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; }
        .slot-option:hover,.slot-option:active { border-color:#667eea; background:#f0f4ff; }
        .slot-option.selected { border-color:#667eea; background:#e3f2fd; }
        .slot-option.short { border-color:#ff9800; background:#fff8f0; }
        .wa-preview { background:#e8f5e9; border:1px solid #4caf50; border-radius:10px; padding:13px; margin-bottom:12px; font-size:13px; color:#2e7d32; }
        .wa-message-box { background:white; padding:10px; border-radius:6px; margin:8px 0; white-space:pre-wrap; font-size:13px; line-height:1.6; }
        .success-bar { background:#c8e6c9; color:#2e7d32; padding:12px 15px; border-radius:8px; margin-bottom:14px; display:none; font-weight:600; }
        .success-bar.show { display:block; }
        .empty-msg { text-align:center; padding:30px 15px; color:#aaa; font-size:15px; }
        .partial-time-input { background:#fff8f0; border:2px solid #ff9800; border-radius:10px; padding:15px; margin:10px 0; }
        .partial-time-input label { font-weight:600; color:#e65100; margin-bottom:8px; display:block; }
        @media (max-width:640px) {
            .desktop-layout { display:none; }
            .mobile-layout { display:block; }
            .bottom-nav { display:block; }
            .desktop-cal { display:none; }
            .mobile-cal { display:block; }
            .form-row { grid-template-columns:1fr; }
            .sync-bar { flex-direction:column; align-items:flex-start; }
        }
        @media (min-width:641px) {
            .desktop-layout { display:block; }
            .mobile-layout { display:none; }
            .bottom-nav { display:none; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>ğŸ“š ×× ×”×œ ××©×™××•×ª ×•××˜×œ×•×ª</h1>
    <p>× ×™×”×•×œ ×–××Ÿ ×—×›× ×œ××˜×œ×•×ª ×‘×™×ª ×”×¡×¤×¨</p>
</div>
<div class="sync-bar">
    <div class="sync-status">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-text">×œ×—×¥ ×”×ª×—×‘×¨ ×œ×¡× ×›×¨×•×Ÿ ×¢× Google Drive</span>
    </div>
    <div class="sync-btns">
        <button class="btn-sync" style="background:#34a853" id="btn-signin" onclick="signIn()">ğŸ”— ×”×ª×—×‘×¨ ×œ-Google</button>
        <button class="btn-sync" style="background:#1a73e8;display:none" id="btn-save" onclick="saveNow()">â˜ï¸ ×©××•×¨ ×¢×›×©×™×•</button>
        <button class="btn-sync" style="background:#188038;display:none" id="btn-load" onclick="loadNow()">ğŸ“¥ ×˜×¢×Ÿ ×-Drive</button>
        <button class="btn-sync" style="background:#666;display:none" id="btn-signout" onclick="signOut()">ğŸšª ×”×ª× ×ª×§</button>
    </div>
</div>
<div class="desktop-layout">
  <div class="desktop-content">
    <div class="success-bar" id="d-success">âœ“ ×”××˜×œ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!</div>
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
            <div class="section-title" style="margin:0;border:none;padding:0">ğŸ“… ×”×™×•××Ÿ ×”×©×‘×•×¢×™ ×©×œ×™</div>
            <button class="btn-export" onclick="exportAllCal()">ğŸ“¤ ×™×™×¦× ×œ-Google Calendar</button>
        </div>
        <div class="calendar-wrapper">
            <div class="cal-nav">
                <button class="cal-nav-btn" onclick="changeWeek(-1)">â†’</button>
                <div class="cal-title" id="d-week-label"></div>
                <button class="cal-nav-btn" onclick="changeWeek(1)">â†</button>
            </div>
            <div class="desktop-cal" style="overflow-x:auto">
                <table class="cal-table" id="d-cal"></table>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f1f8e9;border-right:3px solid #8bc34a"></div>×–××Ÿ ×¤× ×•×™</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fff3e0;border-right:3px solid #ff9800"></div>××ª×•×›× ×Ÿ</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ffebee;border-right:3px solid #f44336"></div>×”×’×©×”</div>
            </div>
        </div>
    </div>
    <div class="stats">
        <div class="stat-card"><div class="stat-number" id="d-total">0</div><div class="stat-label">××©×™××•×ª</div></div>
        <div class="stat-card"><div class="stat-number" id="d-pending">0</div><div class="stat-label">×××ª×™× ×•×ª</div></div>
        <div class="stat-card"><div class="stat-number" id="d-hours">0</div><div class="stat-label">×©×¢×•×ª</div></div>
    </div>
    <div class="section">
        <div class="section-title">â• ×”×•×¡×£ ××©×™××” ×—×“×©×”</div>
        <div class="form-row">
            <div>
                <div class="form-group"><label class="form-label">×©× ×”××˜×œ×”</label><input class="form-input" id="d-name" placeholder="×¢×‘×•×“×” ×‘××ª××˜×™×§×”"></div>
                <div class="form-group"><label class="form-label">××§×¦×•×¢</label>
                    <select class="form-select" id="d-subject">
                        <option value="">×‘×—×¨ ××§×¦×•×¢</option>
                        <option>××ª××˜×™×§×”</option><option>×× ×’×œ×™×ª</option><option>×¢×‘×¨×™×ª</option>
                        <option>×”×™×¡×˜×•×¨×™×”</option><option>××“×¢×™×</option><option>×’×™××•×’×¨×¤×™×”</option>
                        <option>××–×¨×—×•×ª</option><option>××•×× ×•×ª</option><option>×¡×¤×•×¨×˜</option><option>××—×¨</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">×–××Ÿ ××©×•×¢×¨ (×“×§×•×ª)</label><input class="form-input" type="number" id="d-time" placeholder="60" min="5"></div>
            </div>
            <div>
                <div class="form-group"><label class="form-label">×ª××¨×™×š ×”×’×©×”</label><input class="form-input" type="date" id="d-due-date"></div>
                <div class="form-group"><label class="form-label">×©×¢×ª ×”×’×©×”</label><input class="form-input" type="time" id="d-due-time"></div>
                <div class="form-group"><label class="form-label">×ª×™××•×¨ / ×”×¢×¨×•×ª</label><textarea class="form-textarea" id="d-desc" rows="3" placeholder="××™×“×¢ × ×•×¡×£..."></textarea></div>
            </div>
        </div>
        <div class="form-group"><label class="form-label">×× ×™ ×¦×¨×™×›×” ×¢×–×¨×” ×:</label>
            <div class="check-group">
                <label><input type="checkbox" id="d-mom"> ×××</label>
                <label><input type="checkbox" id="d-dad"> ××‘×</label>
                <label><input type="checkbox" id="d-alone" checked> ×× ×™ ×™×›×•×œ×” ×œ×‘×“</label>
            </div>
        </div>
        <div class="form-group" id="d-help-div" style="display:none"><label class="form-label">×¢×œ ××” ××ª ×¦×¨×™×›×” ×¢×–×¨×”?</label><textarea class="form-textarea" id="d-help-msg" rows="2"></textarea></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="addTask('d')">â• ×”×•×¡×£ ××©×™××”</button>
            <button class="btn btn-secondary" onclick="clearForm('d')">ğŸ”„ × ×§×”</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title">ğŸ• ×©×¢×•×ª ×¤× ×•×™×•×ª</div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">×™×•×</label>
                <select class="form-select" id="d-free-day">
                    <option value="">×‘×—×¨ ×™×•×</option>
                    <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option>
                    <option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">×©×¢×ª ×”×ª×—×œ×”</label><input class="form-input" type="time" id="d-free-time"></div>
        </div>
        <div class="form-group"><label class="form-label">××©×š (×“×§×•×ª)</label><input class="form-input" type="number" id="d-free-dur" placeholder="90" min="15"></div>
        <div class="form-group"><label class="form-label">×¡×•×’:</label>
            <div class="radio-group">
                <label><input type="radio" name="d-ftype" value="recurring" checked> ×—×•×–×¨ ×›×œ ×©×‘×•×¢</label>
                <label><input type="radio" name="d-ftype" value="oneTime"> ×—×“ ×¤×¢××™</label>
            </div>
        </div>
        <div class="form-group" id="d-onetime-div" style="display:none"><label class="form-label">×ª××¨×™×š ×¡×¤×¦×™×¤×™</label><input class="form-input" type="date" id="d-onetime-date"></div>
        <button class="btn btn-primary" onclick="addFreeTime('d')">â• ×”×•×¡×£ ×©×¢×” ×¤× ×•×™×”</button>
        <div id="d-free-list"></div>
    </div>
    <div class="section">
        <div class="section-title">ğŸ“‹ ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª</div>
        <div id="d-schedule"><p class="empty-msg">×”×•×¡×£ ××©×™××•×ª ×œ×¨××•×ª ×¢×“×™×¤×•×™×•×ª</p></div>
    </div>
    <div class="section">
        <div class="section-title">ğŸ“ ×”××˜×œ×•×ª ×©×œ×™</div>
        <div id="d-tasks"><div class="empty-msg">××™×Ÿ ××©×™××•×ª. ×”×•×¡×£ ××©×™××” ×¨××©×•× ×”!</div></div>
    </div>
  </div>
</div>
<div class="mobile-layout">
    <div class="mobile-page active" id="m-page-cal">
        <div class="success-bar" id="m-success">âœ“ ×”××˜×œ×” × ×•×¡×¤×”!</div>
        <div class="stats">
            <div class="stat-card"><div class="stat-number" id="m-total">0</div><div class="stat-label">××©×™××•×ª</div></div>
            <div class="stat-card"><div class="stat-number" id="m-pending">0</div><div class="stat-label">×××ª×™× ×•×ª</div></div>
            <div class="stat-card"><div class="stat-number" id="m-hours">0</div><div class="stat-label">×©×¢×•×ª</div></div>
        </div>
        <div class="calendar-wrapper">
            <div class="cal-nav">
                <button class="cal-nav-btn" onclick="changeWeek(-1)">â†’</button>
                <div class="cal-title" id="m-week-label"></div>
                <button class="cal-nav-btn" onclick="changeWeek(1)">â†</button>
            </div>
            <div class="mobile-cal">
                <div class="mobile-day-nav">
                    <button class="mobile-day-nav-btn" onclick="changeMobileDay(-1)">â†’</button>
                    <div class="mobile-day-label" id="m-day-label"></div>
                    <button class="mobile-day-nav-btn" onclick="changeMobileDay(1)">â†</button>
                </div>
                <div class="mobile-day-body" id="m-day-body"></div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f1f8e9;border-right:3px solid #8bc34a"></div>×–××Ÿ ×¤× ×•×™</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fff3e0;border-right:3px solid #ff9800"></div>××ª×•×›× ×Ÿ</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ffebee;border-right:3px solid #f44336"></div>×”×’×©×”</div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">ğŸ“‹ ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª</div>
            <div id="m-schedule"><p class="empty-msg">×”×•×¡×£ ××©×™××•×ª ×œ×¨××•×ª ×¢×“×™×¤×•×™×•×ª</p></div>
        </div>
    </div>
    <div class="mobile-page" id="m-page-add">
        <div class="section-title">â• ×”×•×¡×£ ××©×™××” ×—×“×©×”</div>
        <div class="form-group"><label class="form-label">×©× ×”××˜×œ×” *</label><input class="form-input" id="m-name" placeholder="×¢×‘×•×“×” ×‘××ª××˜×™×§×”"></div>
        <div class="form-group"><label class="form-label">××§×¦×•×¢ *</label>
            <select class="form-select" id="m-subject">
                <option value="">×‘×—×¨ ××§×¦×•×¢</option>
                <option>××ª××˜×™×§×”</option><option>×× ×’×œ×™×ª</option><option>×¢×‘×¨×™×ª</option>
                <option>×”×™×¡×˜×•×¨×™×”</option><option>××“×¢×™×</option><option>×’×™××•×’×¨×¤×™×”</option>
                <option>××–×¨×—×•×ª</option><option>××•×× ×•×ª</option><option>×¡×¤×•×¨×˜</option><option>××—×¨</option>
            </select>
        </div>
        <div class="form-row" style="grid-template-columns:1fr 1fr">
            <div class="form-group"><label class="form-label">×–××Ÿ (×“×§×•×ª) *</label><input class="form-input" type="number" id="m-time" placeholder="60"></div>
            <div class="form-group"><label class="form-label">×ª××¨×™×š ×”×’×©×” *</label><input class="form-input" type="date" id="m-due-date"></div>
        </div>
        <div class="form-group"><label class="form-label">×©×¢×ª ×”×’×©×”</label><input class="form-input" type="time" id="m-due-time"></div>
        <div class="form-group"><label class="form-label">×ª×™××•×¨ / ×”×¢×¨×•×ª</label><textarea class="form-textarea" id="m-desc" rows="2" placeholder="××™×“×¢ × ×•×¡×£..."></textarea></div>
        <div class="form-group"><label class="form-label">×× ×™ ×¦×¨×™×›×” ×¢×–×¨×” ×:</label>
            <div class="check-group">
                <label><input type="checkbox" id="m-mom"> ×××</label>
                <label><input type="checkbox" id="m-dad"> ××‘×</label>
                <label><input type="checkbox" id="m-alone" checked> ×œ×‘×“</label>
            </div>
        </div>
        <div class="form-group" id="m-help-div" style="display:none"><label class="form-label">×¢×œ ××”?</label><textarea class="form-textarea" id="m-help-msg" rows="2"></textarea></div>
        <div class="btn-row">
            <button class="btn btn-primary" style="flex:1" onclick="addTask('m')">â• ×”×•×¡×£ ××©×™××”</button>
            <button class="btn btn-secondary" onclick="clearForm('m')">ğŸ”„</button>
        </div>
    </div>
    <div class="mobile-page" id="m-page-tasks">
        <div class="section-title">ğŸ“ ×”××˜×œ×•×ª ×©×œ×™</div>
        <div id="m-tasks"><div class="empty-msg">××™×Ÿ ××©×™××•×ª. ×œ×—×¥ â• ×œ×”×•×¡×¤×”!</div></div>
    </div>
    <div class="mobile-page" id="m-page-free">
        <div class="section-title">ğŸ• ×©×¢×•×ª ×¤× ×•×™×•×ª</div>
        <div class="form-group"><label class="form-label">×™×•×</label>
            <select class="form-select" id="m-free-day">
                <option value="">×‘×—×¨ ×™×•×</option>
                <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option>
                <option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
            </select>
        </div>
        <div class="form-row" style="grid-template-columns:1fr 1fr">
            <div class="form-group"><label class="form-label">×©×¢×ª ×”×ª×—×œ×”</label><input class="form-input" type="time" id="m-free-time"></div>
            <div class="form-group"><label class="form-label">××©×š (×“×§×•×ª)</label><input class="form-input" type="number" id="m-free-dur" placeholder="90"></div>
        </div>
        <div class="form-group"><label class="form-label">×¡×•×’:</label>
            <div class="radio-group">
                <label><input type="radio" name="m-ftype" value="recurring" checked> ×—×•×–×¨ ×›×œ ×©×‘×•×¢</label>
                <label><input type="radio" name="m-ftype" value="oneTime"> ×—×“ ×¤×¢××™</label>
            </div>
        </div>
        <div class="form-group" id="m-onetime-div" style="display:none"><label class="form-label">×ª××¨×™×š ×¡×¤×¦×™×¤×™</label><input class="form-input" type="date" id="m-onetime-date"></div>
        <button class="btn btn-primary" style="width:100%" onclick="addFreeTime('m')">â• ×”×•×¡×£ ×©×¢×” ×¤× ×•×™×”</button>
        <div id="m-free-list"></div>
    </div>
</div>
<div class="bottom-nav">
    <div class="bottom-nav-inner">
        <button class="nav-btn active" id="nb-cal" onclick="goPage('cal')"><span class="icon">ğŸ“…</span>×™×•××Ÿ</button>
        <button class="nav-btn" id="nb-add" onclick="goPage('add')"><span class="icon">â•</span>×”×•×¡×£</button>
        <button class="nav-btn" id="nb-tasks" onclick="goPage('tasks')"><span class="icon">ğŸ“</span>××©×™××•×ª</button>
        <button class="nav-btn" id="nb-free" onclick="goPage('free')"><span class="icon">ğŸ•</span>×¤× ×•×™</button>
    </div>
</div>
<div class="modal" id="plan-modal">
    <div class="modal-box">
        <div class="modal-head"><h3>ğŸ“… ×ª×›× ×Ÿ ××ª×™ ×œ×‘×¦×¢</h3><span class="modal-close" onclick="closePlan()">&times;</span></div>
        <div id="plan-task-info"></div>
        <div id="plan-slots"></div>
        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-primary" onclick="confirmPlan()">âœ“ ××©×¨</button>
            <button class="btn btn-secondary" onclick="closePlan()">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>
<div class="modal" id="partial-modal">
    <div class="modal-box">
        <div class="modal-head"><h3>â±ï¸ ×—×œ×•×§×ª ××˜×œ×” ×œ×—×œ×§×™×</h3><span class="modal-close" onclick="closePartial()">&times;</span></div>
        <div id="partial-info"></div>
        <div class="partial-time-input">
            <label>×›××” ×“×§×•×ª ×œ×‘×¦×¢ ×¢×›×©×™×•?</label>
            <input class="form-input" type="number" id="partial-minutes" min="5">
            <div id="partial-hint" style="color:#888;font-size:12px;margin-top:6px"></div>
        </div>
        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-primary" onclick="confirmPartial()">âœ“ ××©×¨</button>
            <button class="btn btn-secondary" onclick="closePartial()">×‘×™×˜×•×œ</button>
        </div>
    </div>
</div>
<script src="https://accounts.google.com/gsi/client" async></script>
<script>
var CLIENT_ID = '691427751503-ut47ai714s9a0u0o96d3r66i5pgl95nj.apps.googleusercontent.com';
var SCOPES = 'https://www.googleapis.com/auth/drive.file';
var FILE_NAME = 'task_manager_data.json';
var tasks = [], freeTimes = [];
var weekStart = new Date();
weekStart.setDate(weekStart.getDate() - weekStart.getDay());
weekStart.setHours(0,0,0,0);
var mobileDay = new Date().getDay();
var selSlot = null, planTaskId = null, partialTaskId = null, partialSlot = null;
var tokenClient = null, accessToken = null, driveFileId = null, autoSaveTimer = null;
var DAYS = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];

function save() {
    try {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('fts', JSON.stringify(freeTimes));
        scheduleAutoSave();
    } catch(e) {}
}

function load() {
    try {
        var t = localStorage.getItem('tasks');
        var f = localStorage.getItem('fts');
        if (t) tasks = JSON.parse(t);
        if (f) freeTimes = JSON.parse(f);
    } catch(e) {}
}

function setSyncUI(state, text) {
    var dot = document.getElementById('sync-dot');
    var txt = document.getElementById('sync-text');
    if (dot) dot.className = 'sync-dot ' + (state==='ok'?'synced':state==='work'?'pending':state==='err'?'error':'');
    if (txt) txt.textContent = text;
}

function signIn() {
    if (!window.google) { alert('×˜×•×¢×Ÿ Google... × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”.'); return; }
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: function(resp) {
            if (resp.error) { setSyncUI('err', '×©×’×™××”: ' + resp.error); return; }
            accessToken = resp.access_token;
            document.getElementById('btn-signin').style.display = 'none';
            document.getElementById('btn-save').style.display = 'inline-flex';
            document.getElementById('btn-load').style.display = 'inline-flex';
            document.getElementById('btn-signout').style.display = 'inline-flex';
            setSyncUI('ok', '××—×•×‘×¨ ×œ-Google Drive âœ“');
            loadNow();
        }
    });
    tokenClient.requestAccessToken();
}

function signOut() {
    if (accessToken) google.accounts.oauth2.revoke(accessToken);
    accessToken = null; driveFileId = null;
    document.getElementById('btn-signin').style.display = 'inline-flex';
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('btn-load').style.display = 'none';
    document.getElementById('btn-signout').style.display = 'none';
    setSyncUI('', '×œ×—×¥ ×”×ª×—×‘×¨ ×œ×¡× ×›×¨×•×Ÿ ×¢× Google Drive');
}

function scheduleAutoSave() {
    if (!accessToken) return;
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(saveNow, 3000);
    setSyncUI('work', '×©×•××¨...');
}

async function saveNow() {
    if (!accessToken) { alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×œ-Google Drive'); return; }
    try {
        setSyncUI('work', '×©×•××¨...');
        var data = JSON.stringify({tasks: tasks, freeTimes: freeTimes, savedAt: new Date().toISOString()});
        if (!driveFileId) {
            var searchRes = await fetch("https://www.googleapis.com/drive/v3/files?q=name%3D'" + FILE_NAME + "'+and+trashed%3Dfalse&spaces=drive&fields=files(id)", {headers:{Authorization:'Bearer '+accessToken}});
            var searchJson = await searchRes.json();
            if (searchJson.files && searchJson.files.length > 0) driveFileId = searchJson.files[0].id;
        }
        if (driveFileId) {
            await fetch('https://www.googleapis.com/upload/drive/v3/files/'+driveFileId+'?uploadType=media', {
                method:'PATCH', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}, body:data
            });
        } else {
            var form = new FormData();
            form.append('metadata', new Blob([JSON.stringify({name:FILE_NAME,mimeType:'application/json'})], {type:'application/json'}));
            form.append('file', new Blob([data], {type:'application/json'}));
            var cr = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {method:'POST', headers:{Authorization:'Bearer '+accessToken}, body:form});
            var cj = await cr.json();
            driveFileId = cj.id;
        }
        setSyncUI('ok', '× ×©××¨ âœ“ ' + new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}));
    } catch(e) { setSyncUI('err', '×©×’×™××” ×‘×©××™×¨×”'); }
}

async function loadNow() {
    if (!accessToken) { alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×œ-Google Drive'); return; }
    try {
        setSyncUI('work', '×˜×•×¢×Ÿ...');
        var searchRes = await fetch("https://www.googleapis.com/drive/v3/files?q=name%3D'" + FILE_NAME + "'+and+trashed%3Dfalse&spaces=drive&fields=files(id)", {headers:{Authorization:'Bearer '+accessToken}});
        var searchJson = await searchRes.json();
        if (!searchJson.files || !searchJson.files.length) { setSyncUI('ok', '××—×•×‘×¨ - ××™×Ÿ × ×ª×•× ×™× ×©××•×¨×™× ×¢×“×™×™×Ÿ'); return; }
        driveFileId = searchJson.files[0].id;
        var fileRes = await fetch('https://www.googleapis.com/drive/v3/files/'+driveFileId+'?alt=media', {headers:{Authorization:'Bearer '+accessToken}});
        var fileData = await fileRes.json();
        if (fileData.tasks) tasks = fileData.tasks;
        if (fileData.freeTimes) freeTimes = fileData.freeTimes;
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('fts', JSON.stringify(freeTimes));
        renderAll();
        setSyncUI('ok', '× ×˜×¢×Ÿ ×-Google Drive âœ“ ' + new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}));
    } catch(e) { setSyncUI('err', '×©×’×™××” ×‘×˜×¢×™× ×”'); }
}

function goPage(p) {
    document.querySelectorAll('.mobile-page').forEach(function(el){el.classList.remove('active');});
    document.querySelectorAll('.nav-btn').forEach(function(el){el.classList.remove('active');});
    document.getElementById('m-page-'+p).classList.add('active');
    document.getElementById('nb-'+p).classList.add('active');
    window.scrollTo(0,0);
}

function addTask(ctx) {
    try {
        var name = document.getElementById(ctx+'-name').value.trim();
        var subject = document.getElementById(ctx+'-subject').value;
        var est = parseInt(document.getElementById(ctx+'-time').value) || 0;
        var dueDate = document.getElementById(ctx+'-due-date').value;
        var dueTime = document.getElementById(ctx+'-due-time').value;
        var desc = document.getElementById(ctx+'-desc').value.trim();
        var helpMom = document.getElementById(ctx+'-mom').checked;
        var helpDad = document.getElementById(ctx+'-dad').checked;
        var helpMsgEl = document.getElementById(ctx+'-help-msg');
        var helpMsg = helpMsgEl ? helpMsgEl.value.trim() : '';
        if (!name||!subject||!est||!dueDate) { alert('×× × ××œ×: ×©×, ××§×¦×•×¢, ×–××Ÿ ×•×ª××¨×™×š ×”×’×©×”'); return; }
        var task = {id:Date.now(), name:name, subject:subject, estimatedTime:est, remainingTime:est,
            dueDate:dueDate, dueTime:dueTime, description:desc,
            helpNeeded:helpMom||helpDad, helpMom:helpMom, helpDad:helpDad, helpMessage:helpMsg,
            completed:false, plannedDateTime:null, sessions:[]};
        tasks.push(task);
        save(); showSuccess(ctx); renderAll(); clearForm(ctx);
        if (ctx==='m') goPage('tasks');
        if (helpMom||helpDad) showWA(task, ctx);
    } catch(e) { alert('×©×’×™××”: '+e.message); }
}

function showSuccess(ctx) {
    var el = document.getElementById(ctx==='d'?'d-success':'m-success');
    if (!el) return;
    el.classList.add('show');
    setTimeout(function(){el.classList.remove('show');}, 3000);
}

function clearForm(ctx) {
    ['name','subject','time','due-date','due-time','desc'].forEach(function(f){
        var el = document.getElementById(ctx+'-'+f);
        if (el) el.value = '';
    });
    var mom = document.getElementById(ctx+'-mom'); if (mom) mom.checked = false;
    var dad = document.getElementById(ctx+'-dad'); if (dad) dad.checked = false;
    var alone = document.getElementById(ctx+'-alone'); if (alone) alone.checked = true;
    var hm = document.getElementById(ctx+'-help-msg'); if (hm) hm.value = '';
    var hd = document.getElementById(ctx+'-help-div'); if (hd) hd.style.display = 'none';
}

function deleteTask(id) {
    if (confirm('×œ××—×•×§?')) {
        tasks = tasks.filter(function(t){return t.id!==id;});
        save(); renderAll();
    }
}

function toggleDone(id) {
    var t = tasks.find(function(t){return t.id===id;});
    if (!t) return;
    t.completed = !t.completed;
    if (t.completed) t.remainingTime = 0;
    else t.remainingTime = t.estimatedTime - (t.sessions||[]).reduce(function(s,se){return s+se.duration;},0);
    save(); renderAll();
}

function showWA(task, ctx) {
    var parent = task.helpMom ? '×××' : '××‘×';
    var msg = '×©×œ×•× '+parent+',\n\n×× ×™ ×¦×¨×™×›×” ×¢×–×¨×”! ğŸ™\n\nğŸ“Œ '+task.name+'\nğŸ“˜ '+task.subject+'\nâ° '+task.estimatedTime+' ×“×§×•×ª\nğŸ“… ×”×’×©×”: '+task.dueDate;
    if (task.dueTime) msg += ' ×‘×©×¢×” '+task.dueTime;
    if (task.description) msg += '\n\nğŸ“ '+task.description;
    if (task.helpMessage) msg += '\n\nğŸ’¬ '+task.helpMessage;
    msg += '\n\n×ª×•×“×”! â¤ï¸';
    var enc = btoa(unescape(encodeURIComponent(msg)));
    var div = document.createElement('div');
    div.className = 'wa-preview';
    div.innerHTML = '<strong>ğŸ“± ×”×•×“×¢×” ×œ-WhatsApp:</strong><div class="wa-message-box">'+msg+'</div><button class="btn-whatsapp" id="wa-btn-'+enc.slice(0,8)+'">ğŸ“‹ ×”×¢×ª×§ ×”×•×“×¢×”</button>';
    var list = document.getElementById(ctx==='d'?'d-tasks':'m-tasks');
    if (list) list.insertBefore(div, list.firstChild);
    document.getElementById('wa-btn-'+enc.slice(0,8)).onclick = function(){copyWA(msg, this);};
}

function copyWA(text, btn) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function(){
            btn.textContent = 'âœ“ ×”×•×¢×ª×§!';
            setTimeout(function(){btn.textContent='ğŸ“‹ ×”×¢×ª×§ ×”×•×“×¢×”';}, 2500);
        }).catch(function(){fallbackCopy(text,btn);});
    } else { fallbackCopy(text,btn); }
}

function fallbackCopy(text, btn) {
    var ta = document.createElement('textarea');
    ta.value = text; ta.setAttribute('readonly','');
    ta.style.cssText = 'position:fixed;top:0;left:0;width:2px;height:2px;opacity:0;';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try {
        document.execCommand('copy');
        btn.textContent = 'âœ“ ×”×•×¢×ª×§!';
        setTimeout(function(){btn.textContent='ğŸ“‹ ×”×¢×ª×§ ×”×•×“×¢×”';}, 2500);
    } catch(e) { alert('×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§.\n\n'+text); }
    document.body.removeChild(ta);
}

function addFreeTime(ctx) {
    try {
        var day = document.getElementById(ctx+'-free-day').value;
        var time = document.getElementById(ctx+'-free-time').value;
        var dur = parseInt(document.getElementById(ctx+'-free-dur').value) || 0;
        var typeEl = document.querySelector('input[name="'+ctx+'-ftype"]:checked');
        var type = typeEl ? typeEl.value : 'recurring';
        var odateEl = document.getElementById(ctx+'-onetime-date');
        var odate = odateEl ? odateEl.value : '';
        if (!day||!time||!dur) { alert('×× × ××œ× ×™×•×, ×©×¢×” ×•××©×š'); return; }
        if (type==='oneTime'&&!odate) { alert('×× × ×‘×—×¨ ×ª××¨×™×š'); return; }
        freeTimes.push({id:Date.now(), day:day, time:time, duration:dur, type:type, oneTimeDate:type==='oneTime'?odate:null});
        save(); renderFreeLists(); renderCalendar();
        document.getElementById(ctx+'-free-day').value = '';
        document.getElementById(ctx+'-free-time').value = '';
        document.getElementById(ctx+'-free-dur').value = '';
        if (odateEl) odateEl.value = '';
    } catch(e) { alert('×©×’×™××”: '+e.message); }
}

function deleteFT(id) {
    freeTimes = freeTimes.filter(function(f){return f.id!==id;});
    save(); renderFreeLists(); renderCalendar();
}

function renderFreeLists() {
    ['d','m'].forEach(function(ctx){
        var el = document.getElementById(ctx+'-free-list'); if (!el) return;
        if (!freeTimes.length) { el.innerHTML=''; return; }
        var html = '<div style="margin-top:12px;font-weight:600;margin-bottom:6px;">ğŸ• ×”×©×¢×•×ª ×”×¤× ×•×™×•×ª ×©×œ×™:</div>';
        freeTimes.forEach(function(ft){
            html += '<div class="slot-item '+(ft.type==='recurring'?'recurring':'')+'"><div class="slot-info">';
            if (ft.type==='recurring') html += '<span class="badge-recurring">×—×•×–×¨</span>';
            html += '<strong>×™×•× '+DAYS[parseInt(ft.day)]+'</strong>'+(ft.oneTimeDate?' ('+ft.oneTimeDate+')':'');
            html += '<br>'+ft.time+' - '+addMins(ft.time,ft.duration)+' ('+ft.duration+' ×“×§\')</div>';
            html += '<button class="btn-danger" onclick="deleteFT('+ft.id+')">ğŸ—‘ï¸</button></div>';
        });
        el.innerHTML = html;
    });
}

function addMins(t, m) {
    var parts = t.split(':');
    var tot = parseInt(parts[0])*60 + parseInt(parts[1]) + m;
    return String(Math.floor(tot/60)%24).padStart(2,'0') + ':' + String(tot%60).padStart(2,'0');
}

function getHours() {
    var hrs = new Set();
    freeTimes.forEach(function(ft){ hrs.add(parseInt(ft.time.split(':')[0])); });
    tasks.forEach(function(t){
        (t.sessions||[]).forEach(function(s){ if(s.dateTime) hrs.add(new Date(s.dateTime).getHours()); });
        if (t.plannedDateTime && !(t.sessions&&t.sessions.length)) hrs.add(new Date(t.plannedDateTime).getHours());
        if (t.dueDate&&t.dueTime) hrs.add(new Date(t.dueDate+'T'+t.dueTime).getHours());
    });
    if (!hrs.size) for(var i=7;i<=21;i++) hrs.add(i);
    var arr = Array.from(hrs);
    arr.forEach(function(h){ if(h>0)hrs.add(h-1); if(h<23)hrs.add(h+1); });
    return Array.from(hrs).sort(function(a,b){return a-b;});
}

function getCellEvents(dayIdx, hour) {
    var cd = new Date(weekStart);
    cd.setDate(cd.getDate()+dayIdx); cd.setHours(hour,0,0,0);
    var evs = [];
    var cdStr = cd.toISOString().split('T')[0];
    freeTimes.forEach(function(ft){
        if (parseInt(ft.time.split(':')[0])!==hour) return;
        var match = ft.type==='recurring' && parseInt(ft.day)===dayIdx;
        if (!match && ft.type==='oneTime') match = ft.oneTimeDate===cdStr;
        if (match) evs.push({type:'free-time', text:'ğŸ• '+ft.duration+'\' ×¤× ×•×™'});
    });
    tasks.forEach(function(t){
        var ss = (t.sessions&&t.sessions.length) ? t.sessions : (t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
        ss.forEach(function(s){
            if (!s.dateTime) return;
            var p = new Date(s.dateTime);
            if (p.getDate()===cd.getDate()&&p.getMonth()===cd.getMonth()&&p.getFullYear()===cd.getFullYear()&&p.getHours()===hour)
                evs.push({type:'planned', text:'ğŸ“ '+t.name+(t.sessions&&t.sessions.length>1?' ('+s.duration+'\')'  :'')});
        });
        if (t.dueDate&&!t.completed) {
            var d = new Date(t.dueDate+'T'+(t.dueTime||'00:00'));
            if (d.getDate()===cd.getDate()&&d.getMonth()===cd.getMonth()&&d.getFullYear()===cd.getFullYear()&&d.getHours()===hour)
                evs.push({type:'deadline', text:'âš ï¸ ×”×’×©×”: '+t.name});
        }
    });
    return evs;
}

function renderCalendar() {
    var we = new Date(weekStart); we.setDate(we.getDate()+6);
    var lbl = weekStart.toLocaleDateString('he-IL',{day:'numeric',month:'long'})+' â€” '+we.toLocaleDateString('he-IL',{day:'numeric',month:'long',year:'numeric'});
    ['d-week-label','m-week-label'].forEach(function(id){ var el=document.getElementById(id); if(el)el.textContent=lbl; });
    renderDesktopCal(); renderMobileCal();
}

function renderDesktopCal() {
    var table = document.getElementById('d-cal'); if (!table) return;
    var hours = getHours();
    var html = '<thead><tr><th class="time-col">×©×¢×”</th>';
    for (var i=0;i<7;i++) { var d=new Date(weekStart); d.setDate(d.getDate()+i); html+='<th>'+DAYS[i]+'<br><small>'+d.getDate()+'/'+(d.getMonth()+1)+'</small></th>'; }
    html += '</tr></thead><tbody>';
    hours.forEach(function(h){
        html += '<tr><td class="time-cell">'+String(h).padStart(2,'0')+':00</td>';
        for (var d=0;d<7;d++) {
            var evs = getCellEvents(d,h);
            html += '<td class="day-cell'+(evs.length?' has-event':'')+'">'+evs.map(function(e){return '<div class="cal-event '+e.type+'">'+e.text+'</div>';}).join('')+'</td>';
        }
        html += '</tr>';
    });
    table.innerHTML = html+'</tbody>';
}

function renderMobileCal() {
    var d = new Date(weekStart); d.setDate(d.getDate()+mobileDay);
    var lbl = document.getElementById('m-day-label'); if (lbl) lbl.textContent = DAYS[mobileDay]+', '+d.getDate()+'/'+(d.getMonth()+1);
    var body = document.getElementById('m-day-body'); if (!body) return;
    var hours = getHours();
    body.innerHTML = hours.map(function(h){
        var evs = getCellEvents(mobileDay,h);
        return '<div class="hour-row"><div class="hour-label">'+String(h).padStart(2,'0')+':00</div><div class="hour-events">'+evs.map(function(e){return '<div class="cal-event '+e.type+'">'+e.text+'</div>';}).join('')+'</div></div>';
    }).join('') || '<div class="empty-msg">××™×Ÿ ××™×¨×•×¢×™× ×‘×™×•× ×–×”</div>';
}

function changeWeek(dir) { weekStart.setDate(weekStart.getDate()+dir*7); renderCalendar(); }
function changeMobileDay(dir) { mobileDay=(mobileDay+dir+7)%7; renderMobileCal(); }

function buildCalUrl(title, desc, startDt, durationMins) {
    var sd = new Date(startDt);
    var ed = new Date(sd.getTime() + durationMins*60000);
    function fmt(dt) { return dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; }
    return 'https://calendar.google.com/calendar/render?action=TEMPLATE&text='+encodeURIComponent(title)+'&details='+encodeURIComponent(desc||'')+'&dates='+fmt(sd)+'/'+fmt(ed);
}

function renderTasks() {
    ['d','m'].forEach(function(ctx){
        var el = document.getElementById(ctx+'-tasks'); if (!el) return;
        if (!tasks.length) { el.innerHTML='<div class="empty-msg">××™×Ÿ ××©×™××•×ª. ×”×•×¡×£ ××©×™××” ×¨××©×•× ×”!</div>'; return; }
        var html = '';
        tasks.forEach(function(t){
            var due = t.dueTime ? t.dueDate+' '+t.dueTime : t.dueDate;
            var remaining = t.remainingTime!==undefined ? t.remainingTime : t.estimatedTime;
            var isPartial = remaining>0 && remaining<t.estimatedTime && !t.completed;
            var allS = (t.sessions&&t.sessions.length) ? t.sessions : (t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
            var hasPlanned = allS.length > 0;
            var days = Math.ceil((new Date(t.dueDate)-new Date())/86400000);
            var cardClass = t.completed?'done':isPartial?'partial':hasPlanned?'planned':'';
            html += '<div class="task-card '+cardClass+'">';
            html += '<div class="task-header"><div>';
            html += '<span class="task-name'+(t.completed?' done-text':'')+'">'+t.name+'</span><br>';
            html += '<span class="badge badge-subject">'+t.subject+'</span>';
            if (hasPlanned&&!isPartial) html += '<span class="badge badge-planned">âœ“ ××ª×•×›× ×Ÿ</span>';
            if (isPartial) html += '<span class="badge badge-partial">â³ '+remaining+' ×“×§\' × ×©××¨</span>';
            if (days<=1&&!t.completed) html += '<span class="badge badge-urgent">ğŸ”´ ×“×—×•×£!</span>';
            html += '</div><button class="btn-danger" onclick="deleteTask('+t.id+')">ğŸ—‘ï¸</button></div>';
            html += '<div class="task-meta">â° '+t.estimatedTime+' ×“×§\'';
            if (isPartial) html += ' | â³ × ×©××¨ '+remaining+' ×“×§\'';
            html += ' | ğŸ“… '+due+'</div>';
            if (t.description) html += '<div class="task-meta">ğŸ“ '+t.description+'</div>';
            if (t.helpNeeded) {
                var who = (t.helpMom?'×××':'')+(t.helpMom&&t.helpDad?' ×•':'')+(t.helpDad?'××‘×':'');
                html += '<div class="task-help">ğŸ¤ ×¢×–×¨×” ×'+who+(t.helpMessage?' â€” '+t.helpMessage:'')+'</div>';
            }
            allS.forEach(function(s,i){
                if (!s.dateTime) return;
                var sd = new Date(s.dateTime);
                html += '<div class="task-planned-info">âœ…';
                if (allS.length>1) html += ' ×—×œ×§ '+(i+1)+':';
                html += ' '+sd.toLocaleDateString('he-IL',{weekday:'short',day:'numeric',month:'numeric'})+' '+sd.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
                if (allS.length>1) html += ' ('+s.duration+' ×“×§\')';
                html += '</div>';
            });
            if (isPartial) html += '<div class="task-partial-info">â³ × ×©××¨ '+remaining+' ×“×§×•×ª â€” ×œ×—×¥ ×”×•×¡×£ ×–××Ÿ</div>';
            html += '<div class="task-actions">';
            html += '<label class="task-done-check"><input type="checkbox"'+(t.completed?' checked':'')+' onchange="toggleDone('+t.id+')"> ×”×•×©×œ××”</label>';
            if (!t.completed) {
                var planLabel = isPartial ? '×”×•×¡×£ ×–××Ÿ' : hasPlanned ? '×©× ×”' : '×ª×›× ×Ÿ';
                html += '<button class="btn-success" onclick="openPlan('+t.id+')">ğŸ“… '+planLabel+'</button>';
            }
            allS.forEach(function(s,i){
                if (!s.dateTime) return;
                var desc = (t.description||'')+(t.helpMessage?'\n×¢×–×¨×”: '+t.helpMessage:'');
                var title = allS.length>1 ? t.name+' (×—×œ×§ '+(i+1)+') - '+t.subject : t.name+' - '+t.subject;
                var url = buildCalUrl(title, desc, s.dateTime, s.duration);
                html += '<a href="'+url+'" target="_blank" class="btn-gcal">ğŸ“…'+(allS.length>1?' '+(i+1):'')+'</a>';
            });
            if (t.helpNeeded) html += '<button class="btn-whatsapp" onclick="showWAById('+t.id+',\''+ctx+'\')">ğŸ’¬ WhatsApp</button>';
            html += '</div></div>';
        });
        el.innerHTML = html;
    });
    updateStats();
}

function showWAById(id, ctx) {
    var t = tasks.find(function(t){return t.id===id;});
    if (t) showWA(t, ctx);
}

function updateStats() {
    var tot=tasks.length, pend=tasks.filter(function(t){return !t.completed;}).length;
    var hrs=(tasks.filter(function(t){return !t.completed;}).reduce(function(s,t){return s+(t.remainingTime!==undefined?t.remainingTime:t.estimatedTime);},0)/60).toFixed(1);
    ['d','m'].forEach(function(p){
        var a=document.getElementById(p+'-total'),b=document.getElementById(p+'-pending'),c=document.getElementById(p+'-hours');
        if(a)a.textContent=tot; if(b)b.textContent=pend; if(c)c.textContent=hrs;
    });
}

function renderSchedule() {
    ['d','m'].forEach(function(ctx){
        var el = document.getElementById(ctx+'-schedule'); if (!el) return;
        var pending = tasks.filter(function(t){return !t.completed;}).sort(function(a,b){return new Date(a.dueDate+'T'+(a.dueTime||'23:59'))-new Date(b.dueDate+'T'+(b.dueTime||'23:59'));});
        if (!pending.length) { el.innerHTML='<p class="empty-msg">××™×Ÿ ××©×™××•×ª ×××ª×™× ×•×ª ğŸ‰</p>'; return; }
        var html = '';
        pending.forEach(function(t,i){
            var days=Math.ceil((new Date(t.dueDate)-new Date())/86400000);
            var urg=days<=1?'ğŸ”´ ×“×—×•×£!':days<=3?'ğŸŸ¡ ×‘×§×¨×•×‘':'ğŸŸ¢ ×™×© ×–××Ÿ';
            var remaining=t.remainingTime!==undefined?t.remainingTime:t.estimatedTime;
            var allS=(t.sessions&&t.sessions.length)?t.sessions:(t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
            html += '<div class="schedule-card"><div class="schedule-card-title">'+(i+1)+'. '+t.name+' '+urg+'</div>';
            html += '<div class="schedule-card-meta">ğŸ“˜ '+t.subject+' | â±ï¸ '+remaining+' ×“×§\' | ğŸ“… '+t.dueDate+(days>=0?' | â³ '+days+' ×™××™×':'');
            allS.forEach(function(s,si){
                if (!s.dateTime) return;
                var p=new Date(s.dateTime);
                html += '<br>âœ…'+(allS.length>1?' ×—×œ×§ '+(si+1)+':':'')+' '+p.toLocaleDateString('he-IL',{weekday:'short',day:'numeric',month:'numeric'})+' '+p.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
            });
            html += '</div></div>';
        });
        el.innerHTML = html;
    });
}

function openPlan(id) {
    planTaskId=id; selSlot=null;
    var task=tasks.find(function(t){return t.id===id;}); if (!task) return;
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    document.getElementById('plan-task-info').innerHTML =
        '<div style="background:#f0f4ff;padding:12px;border-radius:8px;margin-bottom:14px">'+
        '<strong style="color:#667eea">'+task.name+'</strong><br>'+
        '<small>'+task.subject+' | × ×©××¨: <strong>'+remaining+' ×“×§\'</strong> | ×”×’×©×”: '+task.dueDate+'</small></div>'+
        '<div style="font-weight:600;margin-bottom:10px">×‘×—×¨ ×–××Ÿ ×¤× ×•×™:</div>';
    var slots=findSlots(task);
    var sd=document.getElementById('plan-slots');
    if (!slots.length) { sd.innerHTML='<p style="color:#f44336;text-align:center;padding:15px">ğŸ˜” ××™×Ÿ ×–×× ×™× ×¤× ×•×™×™×. ×”×•×¡×£ ×©×¢×•×ª ×¤× ×•×™×•×ª!</p>'; }
    else {
        var shtml='';
        slots.forEach(function(s,i){
            var d=new Date(s.dt), isShort=s.dur<remaining;
            shtml += '<div class="slot-option'+(isShort?' short':'')+'" onclick="selSlotFn('+i+',\''+s.dt+'\','+s.dur+','+(isShort?'true':'false')+')">';
            shtml += '<strong>'+d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'numeric'})+'</strong>';
            if (isShort) shtml += ' <small style="color:#e65100">(×—×œ×§×™)</small>';
            shtml += '<br><span style="color:#667eea">â° '+d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})+' - '+s.end+'</span>';
            shtml += ' <span style="background:'+(isShort?'#fff3e0':'#e8f5e9')+';padding:2px 8px;border-radius:5px;font-size:12px">'+s.dur+' ×“×§\' ×¤× ×•×™</span>';
            if (isShort) shtml += '<br><small style="color:#e65100">×™×© ×–××Ÿ ×œ-'+s.dur+' ××ª×•×š '+remaining+' ×“×§×•×ª × ×“×¨×©×•×ª</small>';
            shtml += '</div>';
        });
        sd.innerHTML = shtml;
    }
    document.getElementById('plan-modal').style.display='block';
}

function selSlotFn(i, dt, dur, isShort) {
    selSlot={dt:dt, dur:dur, isShort:isShort};
    document.querySelectorAll('.slot-option').forEach(function(el,idx){el.classList.toggle('selected',idx===i);});
}

function closePlan() { document.getElementById('plan-modal').style.display='none'; selSlot=null; planTaskId=null; }

function confirmPlan() {
    if (!selSlot||!planTaskId) { alert('×× × ×‘×—×¨ ×–××Ÿ'); return; }
    var task=tasks.find(function(t){return t.id===planTaskId;}); if (!task) return;
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    if (selSlot.isShort) { closePlan(); openPartialModal(task,selSlot.dt,selSlot.dur,remaining); }
    else {
        if (!task.sessions) task.sessions=[];
        task.sessions.push({dateTime:selSlot.dt, duration:remaining});
        task.plannedDateTime=selSlot.dt; task.remainingTime=0;
        save(); renderAll(); closePlan();
    }
}

function openPartialModal(task, dt, availDur, remaining) {
    partialTaskId=task.id; partialSlot={dt:dt, availDur:availDur};
    document.getElementById('partial-info').innerHTML =
        '<div style="background:#fff8f0;padding:12px;border-radius:8px;margin-bottom:10px;border:2px solid #ff9800">'+
        '<strong style="color:#e65100">'+task.name+'</strong><br>'+
        '<small>×–××Ÿ ×¤× ×•×™: <strong>'+availDur+' ×“×§×•×ª</strong> | × ×“×¨×©: <strong>'+remaining+' ×“×§×•×ª</strong></small></div>';
    var input=document.getElementById('partial-minutes');
    input.value=availDur; input.max=availDur;
    document.getElementById('partial-hint').textContent='××§×¡×™××•× '+availDur+' ×“×§×•×ª. ×”×©××¨ ×™×ª×•×›× ×Ÿ ×‘× ×¤×¨×“.';
    document.getElementById('partial-modal').style.display='block';
}

function closePartial() { document.getElementById('partial-modal').style.display='none'; partialTaskId=null; partialSlot=null; }

function confirmPartial() {
    var mins=parseInt(document.getElementById('partial-minutes').value)||0;
    var task=tasks.find(function(t){return t.id===partialTaskId;}); if (!task){closePartial();return;}
    if (mins<=0||mins>partialSlot.availDur) { alert('×× × ×”×–×Ÿ ××¡×¤×¨ ×“×§×•×ª ×ª×§×™×Ÿ (×¢×“ '+partialSlot.availDur+')'); return; }
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    if (!task.sessions) task.sessions=[];
    task.sessions.push({dateTime:partialSlot.dt, duration:mins});
    task.plannedDateTime=partialSlot.dt;
    task.remainingTime=Math.max(0,remaining-mins);
    save(); renderAll(); closePartial();
    if (task.remainingTime>0) alert('âœ… ×ª×•×›× ×Ÿ '+mins+' ×“×§×•×ª!\n\n× ×©××¨ ×¢×•×“ '+task.remainingTime+' ×“×§×•×ª.\n×œ×—×¥ ×”×•×¡×£ ×–××Ÿ ×œ×ª×›× ×•×Ÿ ×”×”××©×š.');
}

function findSlots(task) {
    var slots=[], remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    var due=new Date(task.dueDate+'T'+(task.dueTime||'23:59'));
    for (var off=0;off<14;off++) {
        var day=new Date(); day.setDate(day.getDate()+off); day.setHours(0,0,0,0);
        if (day>due) break;
        var dow=day.getDay();
        freeTimes.forEach(function(ft){
            var match=ft.type==='recurring'&&parseInt(ft.day)===dow;
            if (!match&&ft.type==='oneTime') match=ft.oneTimeDate===day.toISOString().split('T')[0];
            if (!match) return;
            var parts=ft.time.split(':');
            var start=new Date(day); start.setHours(parseInt(parts[0]),parseInt(parts[1]),0,0);
            var occ=tasks.some(function(t){
                if (t.id===task.id) return false;
                var allS=(t.sessions&&t.sessions.length)?t.sessions:(t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
                return allS.some(function(s){
                    if (!s.dateTime) return false;
                    var ps=new Date(s.dateTime), pe=new Date(ps.getTime()+s.duration*60000);
                    var se=new Date(start.getTime()+Math.min(ft.duration,remaining)*60000);
                    return start<pe&&se>ps;
                });
            });
            if (!occ) {
                var end=new Date(start.getTime()+Math.min(ft.duration,remaining)*60000);
                slots.push({dt:start.toISOString().slice(0,16), end:end.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}), dur:ft.duration});
            }
        });
    }
    return slots.sort(function(a,b){return new Date(a.dt)-new Date(b.dt);}).slice(0,12);
}

function exportAllCal() {
    var planned=tasks.filter(function(t){return (t.sessions&&t.sessions.length>0)||t.plannedDateTime;});
    if (!planned.length) { alert('××™×Ÿ ××©×™××•×ª ××ª×•×›× × ×•×ª ×œ×™×™×¦×•×'); return; }
    var count=0;
    planned.forEach(function(t){
        var allS=(t.sessions&&t.sessions.length>0)?t.sessions:[{dateTime:t.plannedDateTime,duration:t.estimatedTime}];
        allS.forEach(function(s,i){
            if (!s.dateTime) return;
            setTimeout(function(){
                var title=allS.length>1?t.name+' (×—×œ×§ '+(i+1)+') - '+t.subject:t.name+' - '+t.subject;
                var desc=(t.description||'')+(t.helpMessage?'\n×¢×–×¨×”: '+t.helpMessage:'');
                window.open(buildCalUrl(title,desc,s.dateTime,s.duration),'_blank');
            }, count*700);
            count++;
        });
    });
}

function renderAll() { renderTasks(); renderFreeLists(); renderCalendar(); renderSchedule(); }

window.onclick=function(e){
    if(e.target===document.getElementById('plan-modal'))closePlan();
    if(e.target===document.getElementById('partial-modal'))closePartial();
};

document.addEventListener('DOMContentLoaded', function(){
    load(); renderAll();
    ['d','m'].forEach(function(ctx){
        ['mom','dad','alone'].forEach(function(id){
            var el=document.getElementById(ctx+'-'+id); if(!el)return;
            el.addEventListener('change',function(){
                var needs=document.getElementById(ctx+'-mom').checked||document.getElementById(ctx+'-dad').checked;
                document.getElementById(ctx+'-alone').checked=!needs;
                document.getElementById(ctx+'-help-div').style.display=needs?'block':'none';
            });
        });
        document.querySelectorAll('input[name="'+ctx+'-ftype"]').forEach(function(r){
            r.addEventListener('change',function(){
                var div=document.getElementById(ctx+'-onetime-div');
                if(div)div.style.display=this.value==='oneTime'?'block':'none';
            });
        });
    });
    var pi=document.getElementById('partial-minutes');
    if(pi)pi.addEventListener('input',function(){
        if(!partialSlot)return;
        var t=tasks.find(function(t){return t.id===partialTaskId;});
        var rem=t?t.remainingTime||t.estimatedTime:0;
        document.getElementById('partial-hint').textContent='×™×‘×•×¦×¢: '+this.value+' ×“×§\' | ×™×™×©××¨: '+Math.max(0,rem-parseInt(this.value||0))+' ×“×§\'';
    });
});
</script>
</body>
</html>
