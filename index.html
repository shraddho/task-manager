<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מנהל משימות</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; direction:rtl; }
        .header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:15px 20px; text-align:center; position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .header h1 { font-size:20px; }
        .header p { font-size:12px; opacity:0.85; margin-top:3px; }
        .sync-bar { background:#fff9e6; border-bottom:2px solid #ffc107; padding:10px 15px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; font-size:13px; }
        .sync-status { display:flex; align-items:center; gap:6px; color:#666; font-size:13px; }
        .sync-dot { width:10px; height:10px; border-radius:50%; background:#ccc; flex-shrink:0; }
        .sync-dot.synced { background:#4caf50; }
        .sync-dot.pending { background:#ffc107; animation:pulse 1s infinite; }
        .sync-dot.error { background:#f44336; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .sync-btns { display:flex; gap:8px; flex-wrap:wrap; }
        .btn-sync { color:white; font-size:13px; padding:8px 14px; min-height:36px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .bottom-nav { display:none; position:fixed; bottom:0; left:0; right:0; background:white; border-top:2px solid #eee; z-index:200; }
        .bottom-nav-inner { display:grid; grid-template-columns:repeat(4,1fr); }
        .nav-btn { display:flex; flex-direction:column; align-items:center; padding:10px 5px; background:none; border:none; cursor:pointer; font-size:10px; color:#888; }
        .nav-btn .icon { font-size:22px; margin-bottom:3px; }
        .nav-btn.active { color:#667eea; font-weight:700; }
        .desktop-layout { max-width:1400px; margin:0 auto; background:white; }
        .desktop-content { padding:20px; }
        .mobile-layout { display:none; }
        .mobile-page { display:none; padding:15px; padding-bottom:80px; background:white; min-height:calc(100vh - 55px); }
        .mobile-page.active { display:block; }
        .stats { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px; }
        .stat-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:15px 10px; border-radius:12px; text-align:center; }
        .stat-number { font-size:26px; font-weight:700; }
        .stat-label { font-size:11px; opacity:0.9; margin-top:2px; }
        .calendar-wrapper { background:#f8f9fa; border-radius:12px; padding:15px; margin-bottom:20px; }
        .cal-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .cal-nav-btn { padding:8px 14px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; min-width:44px; min-height:44px; }
        .cal-title { font-weight:600; font-size:14px; text-align:center; flex:1; }
        .cal-table { width:100%; border-collapse:collapse; background:white; border:2px solid #ddd; }
        .cal-table th { background:#667eea; color:white; padding:12px 5px; text-align:center; font-size:12px; border:1px solid #5568d3; }
        .cal-table th.time-col { width:65px; background:#5568d3; }
        .cal-table td { border:1px solid #e0e0e0; padding:3px; vertical-align:top; height:55px; }
        .cal-table td.time-cell { background:#f5f5f5; text-align:center; font-weight:600; font-size:11px; color:#666; }
        .cal-table td.day-cell { background:white; }
        .cal-table td.has-event { background:#fffde7; }
        .mobile-cal { display:none; }
        .mobile-day-nav { display:flex; justify-content:space-between; align-items:center; background:white; border-radius:10px; padding:10px; margin-bottom:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
        .mobile-day-nav-btn { padding:8px 16px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:18px; min-width:44px; min-height:44px; }
        .mobile-day-label { font-weight:700; font-size:16px; text-align:center; color:#333; }
        .mobile-day-body { background:white; border-radius:10px; padding:10px; box-shadow:0 1px 4px rgba(0,0,0,0.1); min-height:200px; }
        .hour-row { display:flex; min-height:52px; border-bottom:1px solid #f0f0f0; padding:4px 0; align-items:flex-start; }
        .hour-label { width:52px; font-size:11px; font-weight:600; color:#999; padding-top:4px; flex-shrink:0; }
        .hour-events { flex:1; }
        .cal-event { padding:3px 7px; margin:2px 0; border-radius:4px; font-size:11px; border-right:3px solid; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .cal-event.free-time { background:#f1f8e9; border-color:#8bc34a; color:#33691e; }
        .cal-event.planned { background:#fff3e0; border-color:#ff9800; color:#e65100; font-weight:600; }
        .cal-event.deadline { background:#ffebee; border-color:#f44336; color:#b71c1c; font-weight:700; }
        .legend { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; font-size:12px; }
        .legend-item { display:flex; align-items:center; gap:5px; }
        .legend-dot { width:14px; height:14px; border-radius:3px; }
        .section { margin-bottom:25px; }
        .section-title { color:#667eea; font-size:18px; font-weight:700; border-bottom:2px solid #667eea; padding-bottom:8px; margin-bottom:14px; }
        .form-group { margin-bottom:13px; }
        .form-label { display:block; margin-bottom:6px; font-weight:600; color:#333; font-size:14px; }
        .form-input,.form-select,.form-textarea { width:100%; padding:13px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px; font-family:inherit; direction:rtl; text-align:right; background:white; -webkit-appearance:none; appearance:none; }
        .form-input:focus,.form-select:focus,.form-textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.15); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .check-group { display:flex; gap:15px; flex-wrap:wrap; align-items:center; }
        .check-group label { display:flex; align-items:center; gap:7px; font-size:15px; cursor:pointer; }
        .check-group input[type=checkbox],.check-group input[type=radio] { width:20px; height:20px; cursor:pointer; accent-color:#667eea; }
        .radio-group { display:flex; gap:15px; flex-wrap:wrap; align-items:center; margin-top:8px; }
        .radio-group label { display:flex; align-items:center; gap:7px; font-size:15px; cursor:pointer; }
        .btn { padding:13px 20px; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.2s; min-height:48px; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
        .btn-secondary { background:#e8e8e8; color:#333; }
        .btn-danger { background:#f44336; color:white; padding:8px 13px; font-size:13px; min-height:36px; border:none; border-radius:8px; cursor:pointer; }
        .btn-success { background:#4caf50; color:white; padding:9px 14px; font-size:13px; min-height:36px; border:none; border-radius:8px; cursor:pointer; }
        .btn-whatsapp { background:#25D366; color:white; padding:9px 14px; font-size:13px; min-height:44px; border:none; border-radius:10px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:5px; }
        .btn-gcal { background:#4285f4; color:white; padding:9px 14px; font-size:13px; min-height:36px; text-decoration:none; border-radius:10px; display:inline-flex; align-items:center; gap:5px; font-weight:600; }
        .btn-export { background:#4285f4; color:white; font-size:13px; padding:9px 14px; min-height:36px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
        .task-card { background:#f9f9f9; border:2px solid #e0e0e0; border-radius:12px; padding:15px; margin-bottom:12px; border-right:5px solid #667eea; }
        .task-card.planned { border-right-color:#4caf50; background:#f1f8f4; }
        .task-card.done { opacity:0.55; }
        .task-card.partial { border-right-color:#ff9800; background:#fff8f0; }
        .task-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:8px; }
        .task-name { font-size:16px; font-weight:700; color:#222; }
        .task-name.done-text { text-decoration:line-through; color:#888; }
        .badge { display:inline-block; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; margin:3px 3px 0 0; }
        .badge-subject { background:#667eea; color:white; }
        .badge-planned { background:#4caf50; color:white; }
        .badge-urgent { background:#f44336; color:white; }
        .badge-partial { background:#ff9800; color:white; }
        .task-meta { font-size:13px; color:#666; line-height:1.8; margin:6px 0; }
        .task-help { background:#fff3e0; border-right:4px solid #ff9800; padding:8px 10px; border-radius:6px; font-size:12px; color:#e65100; margin:8px 0; }
        .task-planned-info { background:#e8f5e9; border-right:4px solid #4caf50; padding:8px 10px; border-radius:6px; font-size:12px; color:#2e7d32; margin:8px 0; }
        .task-partial-info { background:#fff3e0; border-right:4px solid #ff9800; padding:8px 10px; border-radius:6px; font-size:12px; color:#e65100; margin:8px 0; }
        .task-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
        .task-done-check { display:flex; align-items:center; gap:7px; cursor:pointer; font-size:14px; }
        .task-done-check input { width:20px; height:20px; accent-color:#667eea; }
        .slot-item { background:white; border:1px solid #e0e0e0; border-right:4px solid #667eea; border-radius:8px; padding:10px 12px; margin-top:8px; display:flex; justify-content:space-between; align-items:center; }
        .slot-item.recurring { border-right-color:#9c27b0; }
        .slot-info { font-size:13px; line-height:1.7; }
        .badge-recurring { background:#9c27b0; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:5px; }
        .schedule-card { background:white; border-right:4px solid #667eea; border-radius:8px; padding:12px; margin-bottom:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
        .schedule-card-title { font-weight:700; color:#222; margin-bottom:4px; font-size:14px; }
        .schedule-card-meta { font-size:13px; color:#666; line-height:1.7; }
        .modal { display:none; position:fixed; z-index:500; inset:0; background:rgba(0,0,0,0.55); overflow-y:auto; }
        .modal-box { background:white; margin:5% auto 20px; padding:20px; border-radius:14px; width:92%; max-width:520px; }
        .modal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
        .modal-head h3 { color:#667eea; font-size:19px; }
        .modal-close { font-size:26px; cursor:pointer; color:#aaa; line-height:1; }
        .slot-option { background:#f9f9f9; border:2px solid #e0e0e0; border-radius:8px; padding:13px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; }
        .slot-option:hover,.slot-option:active { border-color:#667eea; background:#f0f4ff; }
        .slot-option.selected { border-color:#667eea; background:#e3f2fd; }
        .slot-option.short { border-color:#ff9800; background:#fff8f0; }
        .wa-preview { background:#e8f5e9; border:1px solid #4caf50; border-radius:10px; padding:13px; margin-bottom:12px; font-size:13px; color:#2e7d32; }
        .wa-message-box { background:white; padding:10px; border-radius:6px; margin:8px 0; white-space:pre-wrap; font-size:13px; line-height:1.6; }
        .success-bar { background:#c8e6c9; color:#2e7d32; padding:12px 15px; border-radius:8px; margin-bottom:14px; display:none; font-weight:600; }
        .success-bar.show { display:block; }
        .empty-msg { text-align:center; padding:30px 15px; color:#aaa; font-size:15px; }
        .partial-time-input { background:#fff8f0; border:2px solid #ff9800; border-radius:10px; padding:15px; margin:10px 0; }
        .partial-time-input label { font-weight:600; color:#e65100; margin-bottom:8px; display:block; }
        @media (max-width:640px) {
            .desktop-layout { display:none; }
            .mobile-layout { display:block; }
            .bottom-nav { display:block; }
            .desktop-cal { display:none; }
            .mobile-cal { display:block; }
            .form-row { grid-template-columns:1fr; }
            .sync-bar { flex-direction:column; align-items:flex-start; }
        }
        @media (min-width:641px) {
            .desktop-layout { display:block; }
            .mobile-layout { display:none; }
            .bottom-nav { display:none; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>&#128218; מנהל משימות ומטלות</h1>
    <p>ניהול זמן חכם למטלות בית הספר</p>
</div>
<div class="sync-bar">
    <div class="sync-status">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-text">לחץ התחבר לסנכרון עם Google Drive</span>
    </div>
    <div class="sync-btns">
        <button class="btn-sync" style="background:#34a853" id="btn-signin" onclick="signIn()">התחבר ל-Google</button>
        <button class="btn-sync" style="background:#1a73e8;display:none" id="btn-save" onclick="saveNow()">שמור עכשיו</button>
        <button class="btn-sync" style="background:#188038;display:none" id="btn-load" onclick="loadNow()">טען מ-Drive</button>
        <button class="btn-sync" style="background:#666;display:none" id="btn-signout" onclick="signOut()">התנתק</button>
    </div>
</div>
<div class="desktop-layout">
  <div class="desktop-content">
    <div class="success-bar" id="d-success">המטלה נוספה בהצלחה!</div>
    <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
            <div class="section-title" style="margin:0;border:none;padding:0">היומן השבועי שלי</div>
            <button class="btn-export" onclick="exportAllCal()">ייצא ל-Google Calendar</button>
        </div>
        <div class="calendar-wrapper">
            <div class="cal-nav">
                <button class="cal-nav-btn" onclick="changeWeek(-1)">&#8594;</button>
                <div class="cal-title" id="d-week-label"></div>
                <button class="cal-nav-btn" onclick="changeWeek(1)">&#8592;</button>
            </div>
            <div style="overflow-x:auto">
                <table class="cal-table" id="d-cal"></table>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f1f8e9;border-right:3px solid #8bc34a"></div>זמן פנוי</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fff3e0;border-right:3px solid #ff9800"></div>מתוכנן</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ffebee;border-right:3px solid #f44336"></div>הגשה</div>
            </div>
        </div>
    </div>
    <div class="stats">
        <div class="stat-card"><div class="stat-number" id="d-total">0</div><div class="stat-label">משימות</div></div>
        <div class="stat-card"><div class="stat-number" id="d-pending">0</div><div class="stat-label">ממתינות</div></div>
        <div class="stat-card"><div class="stat-number" id="d-hours">0</div><div class="stat-label">שעות</div></div>
    </div>
    <div class="section">
        <div class="section-title">הוסף משימה חדשה</div>
        <div class="form-row">
            <div>
                <div class="form-group"><label class="form-label">שם המטלה</label><input class="form-input" id="d-name" placeholder="עבודה במתמטיקה"></div>
                <div class="form-group"><label class="form-label">מקצוע</label>
                    <select class="form-select" id="d-subject">
                        <option value="">בחר מקצוע</option>
                        <option>מתמטיקה</option><option>אנגלית</option><option>עברית</option>
                        <option>היסטוריה</option><option>מדעים</option><option>גיאוגרפיה</option>
                        <option>אזרחות</option><option>אומנות</option><option>ספורט</option><option>אחר</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">זמן משוער (דקות)</label><input class="form-input" type="number" id="d-time" placeholder="60" min="5"></div>
            </div>
            <div>
                <div class="form-group"><label class="form-label">תאריך הגשה</label><input class="form-input" type="date" id="d-due-date"></div>
                <div class="form-group"><label class="form-label">שעת הגשה</label><input class="form-input" type="time" id="d-due-time"></div>
                <div class="form-group"><label class="form-label">תיאור / הערות</label><textarea class="form-textarea" id="d-desc" rows="3" placeholder="מידע נוסף..."></textarea></div>
            </div>
        </div>
        <div class="form-group"><label class="form-label">אני צריכה עזרה מ:</label>
            <div class="check-group">
                <label><input type="checkbox" id="d-mom"> אמא</label>
                <label><input type="checkbox" id="d-dad"> אבא</label>
                <label><input type="checkbox" id="d-alone" checked> אני יכולה לבד</label>
            </div>
        </div>
        <div class="form-group" id="d-help-div" style="display:none"><label class="form-label">על מה את צריכה עזרה?</label><textarea class="form-textarea" id="d-help-msg" rows="2"></textarea></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="addTask('d')">הוסף משימה</button>
            <button class="btn btn-secondary" onclick="clearForm('d')">נקה</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title">שעות פנויות</div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">יום</label>
                <select class="form-select" id="d-free-day">
                    <option value="">בחר יום</option>
                    <option value="0">ראשון</option><option value="1">שני</option><option value="2">שלישי</option>
                    <option value="3">רביעי</option><option value="4">חמישי</option><option value="5">שישי</option><option value="6">שבת</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">שעת התחלה</label><input class="form-input" type="time" id="d-free-time"></div>
        </div>
        <div class="form-group"><label class="form-label">משך (דקות)</label><input class="form-input" type="number" id="d-free-dur" placeholder="90" min="15"></div>
        <div class="form-group"><label class="form-label">סוג:</label>
            <div class="radio-group">
                <label><input type="radio" name="d-ftype" value="recurring" checked> חוזר כל שבוע</label>
                <label><input type="radio" name="d-ftype" value="oneTime"> חד פעמי</label>
            </div>
        </div>
        <div class="form-group" id="d-onetime-div" style="display:none"><label class="form-label">תאריך ספציפי</label><input class="form-input" type="date" id="d-onetime-date"></div>
        <button class="btn btn-primary" onclick="addFreeTime('d')">הוסף שעה פנויה</button>
        <div id="d-free-list"></div>
    </div>
    <div class="section">
        <div class="section-title">סדר עדיפויות</div>
        <div id="d-schedule"><p class="empty-msg">הוסף משימות לראות עדיפויות</p></div>
    </div>
    <div class="section">
        <div class="section-title">המטלות שלי</div>
        <div id="d-tasks"><div class="empty-msg">אין משימות. הוסף משימה ראשונה!</div></div>
    </div>
  </div>
</div>
<div class="mobile-layout">
    <div class="mobile-page active" id="m-page-cal">
        <div class="success-bar" id="m-success">המטלה נוספה!</div>
        <div class="stats">
            <div class="stat-card"><div class="stat-number" id="m-total">0</div><div class="stat-label">משימות</div></div>
            <div class="stat-card"><div class="stat-number" id="m-pending">0</div><div class="stat-label">ממתינות</div></div>
            <div class="stat-card"><div class="stat-number" id="m-hours">0</div><div class="stat-label">שעות</div></div>
        </div>
        <div class="calendar-wrapper">
            <div class="cal-nav">
                <button class="cal-nav-btn" onclick="changeWeek(-1)">&#8594;</button>
                <div class="cal-title" id="m-week-label"></div>
                <button class="cal-nav-btn" onclick="changeWeek(1)">&#8592;</button>
            </div>
            <div class="mobile-cal">
                <div class="mobile-day-nav">
                    <button class="mobile-day-nav-btn" onclick="changeMobileDay(-1)">&#8594;</button>
                    <div class="mobile-day-label" id="m-day-label"></div>
                    <button class="mobile-day-nav-btn" onclick="changeMobileDay(1)">&#8592;</button>
                </div>
                <div class="mobile-day-body" id="m-day-body"></div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f1f8e9;border-right:3px solid #8bc34a"></div>זמן פנוי</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fff3e0;border-right:3px solid #ff9800"></div>מתוכנן</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ffebee;border-right:3px solid #f44336"></div>הגשה</div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">סדר עדיפויות</div>
            <div id="m-schedule"><p class="empty-msg">הוסף משימות לראות עדיפויות</p></div>
        </div>
    </div>
    <div class="mobile-page" id="m-page-add">
        <div class="section-title">הוסף משימה חדשה</div>
        <div class="form-group"><label class="form-label">שם המטלה</label><input class="form-input" id="m-name" placeholder="עבודה במתמטיקה"></div>
        <div class="form-group"><label class="form-label">מקצוע</label>
            <select class="form-select" id="m-subject">
                <option value="">בחר מקצוע</option>
                <option>מתמטיקה</option><option>אנגלית</option><option>עברית</option>
                <option>היסטוריה</option><option>מדעים</option><option>גיאוגרפיה</option>
                <option>אזרחות</option><option>אומנות</option><option>ספורט</option><option>אחר</option>
            </select>
        </div>
        <div class="form-row" style="grid-template-columns:1fr 1fr">
            <div class="form-group"><label class="form-label">זמן (דקות)</label><input class="form-input" type="number" id="m-time" placeholder="60"></div>
            <div class="form-group"><label class="form-label">תאריך הגשה</label><input class="form-input" type="date" id="m-due-date"></div>
        </div>
        <div class="form-group"><label class="form-label">שעת הגשה</label><input class="form-input" type="time" id="m-due-time"></div>
        <div class="form-group"><label class="form-label">תיאור / הערות</label><textarea class="form-textarea" id="m-desc" rows="2" placeholder="מידע נוסף..."></textarea></div>
        <div class="form-group"><label class="form-label">אני צריכה עזרה מ:</label>
            <div class="check-group">
                <label><input type="checkbox" id="m-mom"> אמא</label>
                <label><input type="checkbox" id="m-dad"> אבא</label>
                <label><input type="checkbox" id="m-alone" checked> לבד</label>
            </div>
        </div>
        <div class="form-group" id="m-help-div" style="display:none"><label class="form-label">על מה?</label><textarea class="form-textarea" id="m-help-msg" rows="2"></textarea></div>
        <div class="btn-row">
            <button class="btn btn-primary" style="flex:1" onclick="addTask('m')">הוסף משימה</button>
            <button class="btn btn-secondary" onclick="clearForm('m')">נקה</button>
        </div>
    </div>
    <div class="mobile-page" id="m-page-tasks">
        <div class="section-title">המטלות שלי</div>
        <div id="m-tasks"><div class="empty-msg">אין משימות. לחץ להוספה!</div></div>
    </div>
    <div class="mobile-page" id="m-page-free">
        <div class="section-title">שעות פנויות</div>
        <div class="form-group"><label class="form-label">יום</label>
            <select class="form-select" id="m-free-day">
                <option value="">בחר יום</option>
                <option value="0">ראשון</option><option value="1">שני</option><option value="2">שלישי</option>
                <option value="3">רביעי</option><option value="4">חמישי</option><option value="5">שישי</option><option value="6">שבת</option>
            </select>
        </div>
        <div class="form-row" style="grid-template-columns:1fr 1fr">
            <div class="form-group"><label class="form-label">שעת התחלה</label><input class="form-input" type="time" id="m-free-time"></div>
            <div class="form-group"><label class="form-label">משך (דקות)</label><input class="form-input" type="number" id="m-free-dur" placeholder="90"></div>
        </div>
        <div class="form-group"><label class="form-label">סוג:</label>
            <div class="radio-group">
                <label><input type="radio" name="m-ftype" value="recurring" checked> חוזר כל שבוע</label>
                <label><input type="radio" name="m-ftype" value="oneTime"> חד פעמי</label>
            </div>
        </div>
        <div class="form-group" id="m-onetime-div" style="display:none"><label class="form-label">תאריך ספציפי</label><input class="form-input" type="date" id="m-onetime-date"></div>
        <button class="btn btn-primary" style="width:100%" onclick="addFreeTime('m')">הוסף שעה פנויה</button>
        <div id="m-free-list"></div>
    </div>
</div>
<div class="bottom-nav">
    <div class="bottom-nav-inner">
        <button class="nav-btn active" id="nb-cal" onclick="goPage('cal')"><span class="icon">&#128197;</span>יומן</button>
        <button class="nav-btn" id="nb-add" onclick="goPage('add')"><span class="icon">&#10133;</span>הוסף</button>
        <button class="nav-btn" id="nb-tasks" onclick="goPage('tasks')"><span class="icon">&#128221;</span>משימות</button>
        <button class="nav-btn" id="nb-free" onclick="goPage('free')"><span class="icon">&#128336;</span>פנוי</button>
    </div>
</div>
<div class="modal" id="plan-modal">
    <div class="modal-box">
        <div class="modal-head"><h3>תכנן מתי לבצע</h3><span class="modal-close" onclick="closePlan()">&times;</span></div>
        <div id="plan-task-info"></div>
        <div id="plan-slots"></div>
        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-primary" onclick="confirmPlan()">אשר</button>
            <button class="btn btn-secondary" onclick="closePlan()">ביטול</button>
        </div>
    </div>
</div>
<div class="modal" id="partial-modal">
    <div class="modal-box">
        <div class="modal-head"><h3>חלוקת מטלה לחלקים</h3><span class="modal-close" onclick="closePartial()">&times;</span></div>
        <div id="partial-info"></div>
        <div class="partial-time-input">
            <label>כמה דקות לבצע עכשיו?</label>
            <input class="form-input" type="number" id="partial-minutes" min="5">
            <div id="partial-hint" style="color:#888;font-size:12px;margin-top:6px"></div>
        </div>
        <div class="btn-row" style="margin-top:14px">
            <button class="btn btn-primary" onclick="confirmPartial()">אשר</button>
            <button class="btn btn-secondary" onclick="closePartial()">ביטול</button>
        </div>
    </div>
</div>
<script src="https://accounts.google.com/gsi/client" async></script>
<script>
var CLIENT_ID = '691427751503-ut47ai714s9a0u0o96d3r66i5pgl95nj.apps.googleusercontent.com';
var SCOPES = 'https://www.googleapis.com/auth/drive.file';
var FILE_NAME = 'task_manager_data.json';
var tasks = [], freeTimes = [];
var weekStart = new Date();
weekStart.setDate(weekStart.getDate() - weekStart.getDay());
weekStart.setHours(0,0,0,0);
var mobileDay = new Date().getDay();
var selSlot = null, planTaskId = null, partialTaskId = null, partialSlot = null;
var tokenClient = null, accessToken = null, driveFileId = null, autoSaveTimer = null;
var DAYS = ['\u05e8\u05d0\u05e9\u05d5\u05df','\u05e9\u05e0\u05d9','\u05e9\u05dc\u05d9\u05e9\u05d9','\u05e8\u05d1\u05d9\u05e2\u05d9','\u05d7\u05de\u05d9\u05e9\u05d9','\u05e9\u05d9\u05e9\u05d9','\u05e9\u05d1\u05ea'];

function save() {
    try {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        localStorage.setItem('fts', JSON.stringify(freeTimes));
        scheduleAutoSave();
    } catch(e) {}
}

function load() {
    try {
        var t = localStorage.getItem('tasks');
        var f = localStorage.getItem('fts');
        if (t) tasks = JSON.parse(t);
        if (f) freeTimes = JSON.parse(f);
    } catch(e) {}
}

function setSyncUI(state, text) {
    var dot = document.getElementById('sync-dot');
    var txt = document.getElementById('sync-text');
    if (dot) dot.className = 'sync-dot ' + (state==='ok'?'synced':state==='work'?'pending':state==='err'?'error':'');
    if (txt) txt.textContent = text;
}

function signIn() {
    if (!window.google) { alert('\u05d8\u05d5\u05e2\u05df Google... \u05e0\u05e1\u05d4 \u05e9\u05d5\u05d1 \u05d1\u05e2\u05d5\u05d3 \u05e9\u05e0\u05d9\u05d9\u05d4.'); return; }
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: function(resp) {
            if (resp.error) { setSyncUI('err', resp.error); return; }
            accessToken = resp.access_token;
            document.getElementById('btn-signin').style.display = 'none';
            document.getElementById('btn-save').style.display = 'inline-flex';
            document.getElementById('btn-load').style.display = 'inline-flex';
            document.getElementById('btn-signout').style.display = 'inline-flex';
            setSyncUI('ok', '\u05de\u05d7\u05d5\u05d1\u05e8 \u05dc-Google Drive');
            loadNow();
        }
    });
    tokenClient.requestAccessToken();
}

function signOut() {
    if (accessToken) google.accounts.oauth2.revoke(accessToken);
    accessToken = null; driveFileId = null;
    document.getElementById('btn-signin').style.display = 'inline-flex';
    document.getElementById('btn-save').style.display = 'none';
    document.getElementById('btn-load').style.display = 'none';
    document.getElementById('btn-signout').style.display = 'none';
    setSyncUI('', '');
}

function scheduleAutoSave() {
    if (!accessToken) return;
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(saveNow, 3000);
}

function saveNow() {
    if (!accessToken) return;
    setSyncUI('work', '\u05e9\u05d5\u05de\u05e8...');
    var data = JSON.stringify({tasks: tasks, freeTimes: freeTimes});
    var searchUrl = "https://www.googleapis.com/drive/v3/files?q=name%3D'" + FILE_NAME + "'+and+trashed%3Dfalse&spaces=drive&fields=files(id)";
    fetch(searchUrl, {headers:{Authorization:'Bearer '+accessToken}})
    .then(function(r){return r.json();})
    .then(function(res){
        if (res.files && res.files.length > 0) {
            driveFileId = res.files[0].id;
            return fetch('https://www.googleapis.com/upload/drive/v3/files/'+driveFileId+'?uploadType=media',
                {method:'PATCH', headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}, body:data});
        } else {
            var form = new FormData();
            form.append('metadata', new Blob([JSON.stringify({name:FILE_NAME,mimeType:'application/json'})],{type:'application/json'}));
            form.append('file', new Blob([data],{type:'application/json'}));
            return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',
                {method:'POST', headers:{Authorization:'Bearer '+accessToken}, body:form})
            .then(function(r){return r.json();})
            .then(function(j){driveFileId=j.id;});
        }
    })
    .then(function(){
        var t = new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
        setSyncUI('ok', '\u05e0\u05e9\u05de\u05e8 ' + t);
    })
    .catch(function(){setSyncUI('err','\u05e9\u05d2\u05d9\u05d0\u05d4');});
}

function loadNow() {
    if (!accessToken) return;
    setSyncUI('work', '\u05d8\u05d5\u05e2\u05df...');
    var searchUrl = "https://www.googleapis.com/drive/v3/files?q=name%3D'" + FILE_NAME + "'+and+trashed%3Dfalse&spaces=drive&fields=files(id)";
    fetch(searchUrl, {headers:{Authorization:'Bearer '+accessToken}})
    .then(function(r){return r.json();})
    .then(function(res){
        if (!res.files || !res.files.length) { setSyncUI('ok','\u05de\u05d7\u05d5\u05d1\u05e8'); return; }
        driveFileId = res.files[0].id;
        return fetch('https://www.googleapis.com/drive/v3/files/'+driveFileId+'?alt=media',
            {headers:{Authorization:'Bearer '+accessToken}})
        .then(function(r){return r.json();})
        .then(function(d){
            if (d.tasks) tasks = d.tasks;
            if (d.freeTimes) freeTimes = d.freeTimes;
            localStorage.setItem('tasks',JSON.stringify(tasks));
            localStorage.setItem('fts',JSON.stringify(freeTimes));
            renderAll();
            var t = new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
            setSyncUI('ok','\u05e0\u05d8\u05e2\u05df ' + t);
        });
    })
    .catch(function(){setSyncUI('err','\u05e9\u05d2\u05d9\u05d0\u05d4');});
}

function goPage(p) {
    document.querySelectorAll('.mobile-page').forEach(function(el){el.classList.remove('active');});
    document.querySelectorAll('.nav-btn').forEach(function(el){el.classList.remove('active');});
    document.getElementById('m-page-'+p).classList.add('active');
    document.getElementById('nb-'+p).classList.add('active');
    window.scrollTo(0,0);
}

function addTask(ctx) {
    try {
        var name = document.getElementById(ctx+'-name').value.trim();
        var subject = document.getElementById(ctx+'-subject').value;
        var est = parseInt(document.getElementById(ctx+'-time').value) || 0;
        var dueDate = document.getElementById(ctx+'-due-date').value;
        var dueTime = document.getElementById(ctx+'-due-time').value;
        var desc = document.getElementById(ctx+'-desc').value.trim();
        var helpMom = document.getElementById(ctx+'-mom').checked;
        var helpDad = document.getElementById(ctx+'-dad').checked;
        var helpMsgEl = document.getElementById(ctx+'-help-msg');
        var helpMsg = helpMsgEl ? helpMsgEl.value.trim() : '';
        if (!name||!subject||!est||!dueDate) { alert('Please fill all fields'); return; }
        var task = {id:Date.now(), name:name, subject:subject, estimatedTime:est, remainingTime:est,
            dueDate:dueDate, dueTime:dueTime, description:desc,
            helpNeeded:helpMom||helpDad, helpMom:helpMom, helpDad:helpDad, helpMessage:helpMsg,
            completed:false, plannedDateTime:null, sessions:[]};
        tasks.push(task);
        save(); showSuccess(ctx); renderAll(); clearForm(ctx);
        if (ctx==='m') goPage('tasks');
        if (helpMom||helpDad) showWA(task, ctx);
    } catch(e) { alert(e.message); }
}

function showSuccess(ctx) {
    var el = document.getElementById(ctx==='d'?'d-success':'m-success');
    if (!el) return;
    el.classList.add('show');
    setTimeout(function(){el.classList.remove('show');}, 3000);
}

function clearForm(ctx) {
    ['name','subject','time','due-date','due-time','desc'].forEach(function(f){
        var el = document.getElementById(ctx+'-'+f);
        if (el) el.value = '';
    });
    var mom=document.getElementById(ctx+'-mom'); if(mom)mom.checked=false;
    var dad=document.getElementById(ctx+'-dad'); if(dad)dad.checked=false;
    var alone=document.getElementById(ctx+'-alone'); if(alone)alone.checked=true;
    var hm=document.getElementById(ctx+'-help-msg'); if(hm)hm.value='';
    var hd=document.getElementById(ctx+'-help-div'); if(hd)hd.style.display='none';
}

function deleteTask(id) {
    if (confirm('?')) {
        tasks = tasks.filter(function(t){return t.id!==id;});
        save(); renderAll();
    }
}

function toggleDone(id) {
    var t = tasks.find(function(x){return x.id===id;});
    if (!t) return;
    t.completed = !t.completed;
    if (t.completed) t.remainingTime = 0;
    else t.remainingTime = t.estimatedTime - (t.sessions||[]).reduce(function(s,se){return s+se.duration;},0);
    save(); renderAll();
}

function showWA(task, ctx) {
    var parent = task.helpMom ? DAYS[0] : DAYS[0];
    var lines = [];
    lines.push(task.name);
    lines.push(task.subject);
    lines.push(task.estimatedTime + ' min');
    lines.push(task.dueDate);
    if (task.dueTime) lines.push(task.dueTime);
    if (task.description) lines.push(task.description);
    if (task.helpMessage) lines.push(task.helpMessage);
    var msg = lines.join('\n');
    var div = document.createElement('div');
    div.className = 'wa-preview';
    var box = document.createElement('div');
    box.className = 'wa-message-box';
    box.textContent = msg;
    var btn = document.createElement('button');
    btn.className = 'btn-whatsapp';
    btn.textContent = 'Copy';
    btn.onclick = function(){copyWA(msg,btn);};
    div.appendChild(box);
    div.appendChild(btn);
    var list = document.getElementById(ctx==='d'?'d-tasks':'m-tasks');
    if (list) list.insertBefore(div, list.firstChild);
}

function copyWA(text, btn) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function(){
            btn.textContent = 'Copied!';
            setTimeout(function(){btn.textContent='Copy';},2500);
        }).catch(function(){fallbackCopy(text,btn);});
    } else { fallbackCopy(text,btn); }
}

function fallbackCopy(text, btn) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;opacity:0;';
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); btn.textContent='Copied!'; setTimeout(function(){btn.textContent='Copy';},2500); }
    catch(e) { alert(text); }
    document.body.removeChild(ta);
}

function addFreeTime(ctx) {
    try {
        var day = document.getElementById(ctx+'-free-day').value;
        var time = document.getElementById(ctx+'-free-time').value;
        var dur = parseInt(document.getElementById(ctx+'-free-dur').value) || 0;
        var typeEl = document.querySelector('input[name="'+ctx+'-ftype"]:checked');
        var type = typeEl ? typeEl.value : 'recurring';
        var odateEl = document.getElementById(ctx+'-onetime-date');
        var odate = odateEl ? odateEl.value : '';
        if (!day||!time||!dur) { alert('Fill all fields'); return; }
        if (type==='oneTime'&&!odate) { alert('Pick date'); return; }
        freeTimes.push({id:Date.now(),day:day,time:time,duration:dur,type:type,oneTimeDate:type==='oneTime'?odate:null});
        save(); renderFreeLists(); renderCalendar();
        document.getElementById(ctx+'-free-day').value='';
        document.getElementById(ctx+'-free-time').value='';
        document.getElementById(ctx+'-free-dur').value='';
        if(odateEl)odateEl.value='';
    } catch(e) { alert(e.message); }
}

function deleteFT(id) {
    freeTimes = freeTimes.filter(function(f){return f.id!==id;});
    save(); renderFreeLists(); renderCalendar();
}

function renderFreeLists() {
    ['d','m'].forEach(function(ctx){
        var el = document.getElementById(ctx+'-free-list'); if (!el) return;
        if (!freeTimes.length) { el.innerHTML=''; return; }
        var html = '<div style="margin-top:12px;font-weight:600;margin-bottom:6px;">Free times:</div>';
        freeTimes.forEach(function(ft){
            html += '<div class="slot-item '+(ft.type==='recurring'?'recurring':'')+'"><div class="slot-info">';
            html += '<strong>'+DAYS[parseInt(ft.day)]+'</strong> '+ft.time+'-'+addMins(ft.time,ft.duration)+' ('+ft.duration+' min)</div>';
            html += '<button class="btn-danger" onclick="deleteFT('+ft.id+')">X</button></div>';
        });
        el.innerHTML = html;
    });
}

function addMins(t,m){
    var p=t.split(':');
    var tot=parseInt(p[0])*60+parseInt(p[1])+m;
    return String(Math.floor(tot/60)%24).padStart(2,'0')+':'+String(tot%60).padStart(2,'0');
}

function getHours(){
    var hrs=new Set();
    freeTimes.forEach(function(ft){hrs.add(parseInt(ft.time.split(':')[0]));});
    tasks.forEach(function(t){
        (t.sessions||[]).forEach(function(s){if(s.dateTime)hrs.add(new Date(s.dateTime).getHours());});
        if(t.plannedDateTime&&!(t.sessions&&t.sessions.length))hrs.add(new Date(t.plannedDateTime).getHours());
        if(t.dueDate&&t.dueTime)hrs.add(new Date(t.dueDate+'T'+t.dueTime).getHours());
    });
    if(!hrs.size)for(var i=7;i<=21;i++)hrs.add(i);
    var arr=Array.from(hrs);
    arr.forEach(function(h){if(h>0)hrs.add(h-1);if(h<23)hrs.add(h+1);});
    return Array.from(hrs).sort(function(a,b){return a-b;});
}

function getCellEvents(dayIdx,hour){
    var cd=new Date(weekStart);
    cd.setDate(cd.getDate()+dayIdx);cd.setHours(hour,0,0,0);
    var evs=[];
    var cdStr=cd.toISOString().split('T')[0];
    freeTimes.forEach(function(ft){
        if(parseInt(ft.time.split(':')[0])!==hour)return;
        var match=ft.type==='recurring'&&parseInt(ft.day)===dayIdx;
        if(!match&&ft.type==='oneTime')match=ft.oneTimeDate===cdStr;
        if(match)evs.push({type:'free-time',text:'Free '+ft.duration+'min'});
    });
    tasks.forEach(function(t){
        var ss=(t.sessions&&t.sessions.length)?t.sessions:(t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
        ss.forEach(function(s){
            if(!s.dateTime)return;
            var p=new Date(s.dateTime);
            if(p.getDate()===cd.getDate()&&p.getMonth()===cd.getMonth()&&p.getFullYear()===cd.getFullYear()&&p.getHours()===hour)
                evs.push({type:'planned',text:t.name});
        });
        if(t.dueDate&&!t.completed){
            var d=new Date(t.dueDate+'T'+(t.dueTime||'00:00'));
            if(d.getDate()===cd.getDate()&&d.getMonth()===cd.getMonth()&&d.getFullYear()===cd.getFullYear()&&d.getHours()===hour)
                evs.push({type:'deadline',text:t.name});
        }
    });
    return evs;
}

function renderCalendar(){
    var we=new Date(weekStart);we.setDate(we.getDate()+6);
    var lbl=weekStart.toLocaleDateString('he-IL',{day:'numeric',month:'long'})+' - '+we.toLocaleDateString('he-IL',{day:'numeric',month:'long',year:'numeric'});
    ['d-week-label','m-week-label'].forEach(function(id){var el=document.getElementById(id);if(el)el.textContent=lbl;});
    renderDesktopCal();renderMobileCal();
}

function renderDesktopCal(){
    var table=document.getElementById('d-cal');if(!table)return;
    var hours=getHours();
    var html='<thead><tr><th class="time-col">Time</th>';
    for(var i=0;i<7;i++){var d=new Date(weekStart);d.setDate(d.getDate()+i);html+='<th>'+DAYS[i]+'<br><small>'+d.getDate()+'/'+(d.getMonth()+1)+'</small></th>';}
    html+='</tr></thead><tbody>';
    hours.forEach(function(h){
        html+='<tr><td class="time-cell">'+String(h).padStart(2,'0')+':00</td>';
        for(var d=0;d<7;d++){
            var evs=getCellEvents(d,h);
            html+='<td class="day-cell'+(evs.length?' has-event':'')+'">'+evs.map(function(e){return '<div class="cal-event '+e.type+'">'+e.text+'</div>';}).join('')+'</td>';
        }
        html+='</tr>';
    });
    table.innerHTML=html+'</tbody>';
}

function renderMobileCal(){
    var d=new Date(weekStart);d.setDate(d.getDate()+mobileDay);
    var lbl=document.getElementById('m-day-label');
    if(lbl)lbl.textContent=DAYS[mobileDay]+' '+d.getDate()+'/'+(d.getMonth()+1);
    var body=document.getElementById('m-day-body');if(!body)return;
    var hours=getHours();
    body.innerHTML=hours.map(function(h){
        var evs=getCellEvents(mobileDay,h);
        return '<div class="hour-row"><div class="hour-label">'+String(h).padStart(2,'0')+':00</div><div class="hour-events">'+evs.map(function(e){return '<div class="cal-event '+e.type+'">'+e.text+'</div>';}).join('')+'</div></div>';
    }).join('') || '<div class="empty-msg">No events</div>';
}

function changeWeek(dir){weekStart.setDate(weekStart.getDate()+dir*7);renderCalendar();}
function changeMobileDay(dir){mobileDay=(mobileDay+dir+7)%7;renderMobileCal();}

function buildCalUrl(title,desc,startDt,durationMins){
    var sd=new Date(startDt);
    var ed=new Date(sd.getTime()+durationMins*60000);
    function fmt(dt){return dt.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';}
    return 'https://calendar.google.com/calendar/render?action=TEMPLATE&text='+encodeURIComponent(title)+'&details='+encodeURIComponent(desc||'')+'&dates='+fmt(sd)+'/'+fmt(ed);
}

function renderTasks(){
    ['d','m'].forEach(function(ctx){
        var el=document.getElementById(ctx+'-tasks');if(!el)return;
        if(!tasks.length){el.innerHTML='<div class="empty-msg">No tasks yet</div>';return;}
        var html='';
        tasks.forEach(function(t){
            var due=t.dueTime?t.dueDate+' '+t.dueTime:t.dueDate;
            var remaining=t.remainingTime!==undefined?t.remainingTime:t.estimatedTime;
            var isPartial=remaining>0&&remaining<t.estimatedTime&&!t.completed;
            var allS=(t.sessions&&t.sessions.length)?t.sessions:(t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
            var hasPlanned=allS.length>0;
            var days=Math.ceil((new Date(t.dueDate)-new Date())/86400000);
            var cardClass=t.completed?'done':isPartial?'partial':hasPlanned?'planned':'';
            html+='<div class="task-card '+cardClass+'">';
            html+='<div class="task-header"><div>';
            html+='<span class="task-name'+(t.completed?' done-text':'')+'">'+t.name+'</span><br>';
            html+='<span class="badge badge-subject">'+t.subject+'</span>';
            if(hasPlanned&&!isPartial)html+='<span class="badge badge-planned">Planned</span>';
            if(isPartial)html+='<span class="badge badge-partial">'+remaining+' min left</span>';
            if(days<=1&&!t.completed)html+='<span class="badge badge-urgent">Urgent</span>';
            html+='</div><button class="btn-danger" onclick="deleteTask('+t.id+')">X</button></div>';
            html+='<div class="task-meta">'+t.estimatedTime+' min | '+due+'</div>';
            if(t.description)html+='<div class="task-meta">'+t.description+'</div>';
            if(t.helpNeeded)html+='<div class="task-help">Help needed'+(t.helpMessage?': '+t.helpMessage:'')+'</div>';
            allS.forEach(function(s,i){
                if(!s.dateTime)return;
                var sd=new Date(s.dateTime);
                html+='<div class="task-planned-info">Planned: '+sd.toLocaleDateString('he-IL')+'</div>';
            });
            if(isPartial)html+='<div class="task-partial-info">'+remaining+' min remaining</div>';
            html+='<div class="task-actions">';
            html+='<label class="task-done-check"><input type="checkbox"'+(t.completed?' checked':'')+' onchange="toggleDone('+t.id+')"> Done</label>';
            if(!t.completed){
                var planLabel=isPartial?'Add time':hasPlanned?'Change':'Plan';
                html+='<button class="btn-success" onclick="openPlan('+t.id+')">'+planLabel+'</button>';
            }
            allS.forEach(function(s,i){
                if(!s.dateTime)return;
                var desc=(t.description||'')+(t.helpMessage?'\n'+t.helpMessage:'');
                var title=t.name+' - '+t.subject;
                var url=buildCalUrl(title,desc,s.dateTime,s.duration);
                html+='<a href="'+url+'" target="_blank" class="btn-gcal">Cal</a>';
            });
            if(t.helpNeeded)html+='<button class="btn-whatsapp" onclick="showWAById('+t.id+',\''+ctx+'\')">WA</button>';
            html+='</div></div>';
        });
        el.innerHTML=html;
    });
    updateStats();
}

function showWAById(id,ctx){
    var t=tasks.find(function(x){return x.id===id;});
    if(t)showWA(t,ctx);
}

function updateStats(){
    var tot=tasks.length,pend=tasks.filter(function(t){return !t.completed;}).length;
    var hrs=(tasks.filter(function(t){return !t.completed;}).reduce(function(s,t){return s+(t.remainingTime!==undefined?t.remainingTime:t.estimatedTime);},0)/60).toFixed(1);
    ['d','m'].forEach(function(p){
        var a=document.getElementById(p+'-total'),b=document.getElementById(p+'-pending'),c=document.getElementById(p+'-hours');
        if(a)a.textContent=tot;if(b)b.textContent=pend;if(c)c.textContent=hrs;
    });
}

function renderSchedule(){
    ['d','m'].forEach(function(ctx){
        var el=document.getElementById(ctx+'-schedule');if(!el)return;
        var pending=tasks.filter(function(t){return !t.completed;}).sort(function(a,b){return new Date(a.dueDate)-new Date(b.dueDate);});
        if(!pending.length){el.innerHTML='<p class="empty-msg">All done!</p>';return;}
        var html='';
        pending.forEach(function(t,i){
            var days=Math.ceil((new Date(t.dueDate)-new Date())/86400000);
            var urg=days<=1?'URGENT':days<=3?'Soon':'OK';
            var remaining=t.remainingTime!==undefined?t.remainingTime:t.estimatedTime;
            html+='<div class="schedule-card"><div class="schedule-card-title">'+(i+1)+'. '+t.name+' '+urg+'</div>';
            html+='<div class="schedule-card-meta">'+t.subject+' | '+remaining+' min | '+t.dueDate+'</div></div>';
        });
        el.innerHTML=html;
    });
}

function openPlan(id){
    planTaskId=id;selSlot=null;
    var task=tasks.find(function(t){return t.id===id;});if(!task)return;
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    document.getElementById('plan-task-info').innerHTML='<div style="padding:12px;background:#f0f4ff;border-radius:8px;margin-bottom:14px"><strong>'+task.name+'</strong><br><small>'+task.subject+' | '+remaining+' min remaining</small></div><div style="font-weight:600;margin-bottom:10px">Select free slot:</div>';
    var slots=findSlots(task);
    var sd=document.getElementById('plan-slots');
    if(!slots.length){sd.innerHTML='<p style="color:#f44336;text-align:center">No free slots. Add free times first!</p>';return;}
    var shtml='';
    slots.forEach(function(s,i){
        var d=new Date(s.dt),isShort=s.dur<remaining;
        shtml+='<div class="slot-option'+(isShort?' short':'')+'" onclick="selSlotFn('+i+',\''+s.dt+'\','+s.dur+','+(isShort?'true':'false')+')">';
        shtml+='<strong>'+d.toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'numeric'})+'</strong>';
        if(isShort)shtml+=' <small style="color:#e65100">(partial)</small>';
        shtml+='<br><span style="color:#667eea">'+d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})+' - '+s.end+'</span>';
        shtml+=' <span style="background:'+(isShort?'#fff3e0':'#e8f5e9')+';padding:2px 8px;border-radius:5px;font-size:12px">'+s.dur+' min free</span>';
        shtml+='</div>';
    });
    sd.innerHTML=shtml;
    document.getElementById('plan-modal').style.display='block';
}

function selSlotFn(i,dt,dur,isShort){
    selSlot={dt:dt,dur:dur,isShort:isShort};
    document.querySelectorAll('.slot-option').forEach(function(el,idx){el.classList.toggle('selected',idx===i);});
}

function closePlan(){document.getElementById('plan-modal').style.display='none';selSlot=null;planTaskId=null;}

function confirmPlan(){
    if(!selSlot||!planTaskId){alert('Select a slot');return;}
    var task=tasks.find(function(t){return t.id===planTaskId;});if(!task)return;
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    if(selSlot.isShort){closePlan();openPartialModal(task,selSlot.dt,selSlot.dur,remaining);}
    else{
        if(!task.sessions)task.sessions=[];
        task.sessions.push({dateTime:selSlot.dt,duration:remaining});
        task.plannedDateTime=selSlot.dt;task.remainingTime=0;
        save();renderAll();closePlan();
    }
}

function openPartialModal(task,dt,availDur,remaining){
    partialTaskId=task.id;partialSlot={dt:dt,availDur:availDur};
    document.getElementById('partial-info').innerHTML='<div style="padding:12px;background:#fff8f0;border-radius:8px;margin-bottom:10px;border:2px solid #ff9800"><strong>'+task.name+'</strong><br><small>Available: '+availDur+' min | Needed: '+remaining+' min</small></div>';
    var input=document.getElementById('partial-minutes');
    input.value=availDur;input.max=availDur;
    document.getElementById('partial-hint').textContent='Max '+availDur+' min. Rest will be scheduled separately.';
    document.getElementById('partial-modal').style.display='block';
}

function closePartial(){document.getElementById('partial-modal').style.display='none';partialTaskId=null;partialSlot=null;}

function confirmPartial(){
    var mins=parseInt(document.getElementById('partial-minutes').value)||0;
    var task=tasks.find(function(t){return t.id===partialTaskId;});if(!task){closePartial();return;}
    if(mins<=0||mins>partialSlot.availDur){alert('Invalid minutes');return;}
    var remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    if(!task.sessions)task.sessions=[];
    task.sessions.push({dateTime:partialSlot.dt,duration:mins});
    task.plannedDateTime=partialSlot.dt;
    task.remainingTime=Math.max(0,remaining-mins);
    save();renderAll();closePartial();
    if(task.remainingTime>0)alert('Planned '+mins+' min. '+task.remainingTime+' min remaining.');
}

function findSlots(task){
    var slots=[],remaining=task.remainingTime!==undefined?task.remainingTime:task.estimatedTime;
    var due=new Date(task.dueDate+'T'+(task.dueTime||'23:59'));
    for(var off=0;off<14;off++){
        var day=new Date();day.setDate(day.getDate()+off);day.setHours(0,0,0,0);
        if(day>due)break;
        var dow=day.getDay();
        freeTimes.forEach(function(ft){
            var match=ft.type==='recurring'&&parseInt(ft.day)===dow;
            if(!match&&ft.type==='oneTime')match=ft.oneTimeDate===day.toISOString().split('T')[0];
            if(!match)return;
            var parts=ft.time.split(':');
            var start=new Date(day);start.setHours(parseInt(parts[0]),parseInt(parts[1]),0,0);
            var occ=tasks.some(function(t){
                if(t.id===task.id)return false;
                var allS=(t.sessions&&t.sessions.length)?t.sessions:(t.plannedDateTime?[{dateTime:t.plannedDateTime,duration:t.estimatedTime}]:[]);
                return allS.some(function(s){
                    if(!s.dateTime)return false;
                    var ps=new Date(s.dateTime),pe=new Date(ps.getTime()+s.duration*60000);
                    var se=new Date(start.getTime()+Math.min(ft.duration,remaining)*60000);
                    return start<pe&&se>ps;
                });
            });
            if(!occ){
                var end=new Date(start.getTime()+Math.min(ft.duration,remaining)*60000);
                slots.push({dt:start.toISOString().slice(0,16),end:end.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}),dur:ft.duration});
            }
        });
    }
    return slots.sort(function(a,b){return new Date(a.dt)-new Date(b.dt);}).slice(0,12);
}

function exportAllCal(){
    var planned=tasks.filter(function(t){return(t.sessions&&t.sessions.length>0)||t.plannedDateTime;});
    if(!planned.length){alert('No planned tasks');return;}
    var count=0;
    planned.forEach(function(t){
        var allS=(t.sessions&&t.sessions.length>0)?t.sessions:[{dateTime:t.plannedDateTime,duration:t.estimatedTime}];
        allS.forEach(function(s,i){
            if(!s.dateTime)return;
            setTimeout(function(){
                var title=t.name+' - '+t.subject;
                var desc=(t.description||'')+(t.helpMessage?'\n'+t.helpMessage:'');
                window.open(buildCalUrl(title,desc,s.dateTime,s.duration),'_blank');
            },count*700);
            count++;
        });
    });
}

function renderAll(){renderTasks();renderFreeLists();renderCalendar();renderSchedule();}

window.onclick=function(e){
    if(e.target===document.getElementById('plan-modal'))closePlan();
    if(e.target===document.getElementById('partial-modal'))closePartial();
};

document.addEventListener('DOMContentLoaded',function(){
    load();renderAll();
    ['d','m'].forEach(function(ctx){
        ['mom','dad','alone'].forEach(function(id){
            var el=document.getElementById(ctx+'-'+id);if(!el)return;
            el.addEventListener('change',function(){
                var needs=document.getElementById(ctx+'-mom').checked||document.getElementById(ctx+'-dad').checked;
                document.getElementById(ctx+'-alone').checked=!needs;
                document.getElementById(ctx+'-help-div').style.display=needs?'block':'none';
            });
        });
        document.querySelectorAll('input[name="'+ctx+'-ftype"]').forEach(function(r){
            r.addEventListener('change',function(){
                var div=document.getElementById(ctx+'-onetime-div');
                if(div)div.style.display=this.value==='oneTime'?'block':'none';
            });
        });
    });
    var pi=document.getElementById('partial-minutes');
    if(pi)pi.addEventListener('input',function(){
        if(!partialSlot)return;
        var t=tasks.find(function(t){return t.id===partialTaskId;});
        var rem=t?t.remainingTime||t.estimatedTime:0;
        document.getElementById('partial-hint').textContent=this.value+' min now | '+(rem-parseInt(this.value||0))+' min remaining';
    });
});
</script>
</body>
</html>
